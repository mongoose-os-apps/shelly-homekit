author: Shelly-HomeKit contributors
description: A HomeKit firmware for Shelly switches
version: 2.14.2

libs_version: latest
modules_version: latest
mongoose_os_version: latest

sources:
  - src
  - src/mock
  - src/${build_vars.MODEL}

includes:
  - src

filesystem:
  - fs

config_schema:
  - ["debug.event_level", 3]
  - ["dns_sd.txt", "fw_type=homekit"]  # To be easily distinguishable from stock.
  - ["file_logger.level", 3]
  - ["file_logger.max_num_files", 1]
  - ["file_logger.max_file_size", 16000]
  - ["file_logger.buf_size", 1000]
  - ["http.auth_algo", 1]  # SHA-256
  - ["http.auth_domain", ""]
  - ["rpc.auth_algo", 1]  # SHA-256
  - ["rpc.auth_domain", ""]
  - ["sntp.enable", true]

  - ["shelly.name", "s", "", {title: "User-facing device name"}]  # Note: will be overridden by cfg 2 -> 3 migration.
  - ["shelly.mode", "i", 0, {title: "System mode: 0 - default, 1 - roller shutter (if supported), 2 - garage door opener (if supported), 3 - RGB (if supported), 4 - RGBW (if supported), 5 - RGB+W (if supported), 6 - CCT (if supported), 7 - White Mode (if supported)"}]
  - ["shelly.cfg_version", "i", 0, {title: "Configuration version"}]
  - ["shelly.legacy_hap_layout", "b", false, {title: "Use legacy accessory layout instead of a bridged accessory"}]
  - ["shelly.overheat_on", "i", 100, {title: "Overheat protection mode kicks in at or above this temperature"}]
  - ["shelly.overheat_off", "i", 90, {title: "Overheat protection mode turns off when the temperature is back below this threshold"}]
  - ["shelly.reboot_counter", "i", 0, {title: "Counter of boot tries with a uptime of less then 10 sec."}]

  - ["ts", "o", {title: "Temperature Sensor settings", abstract: true}]
  - ["ts.name", "s", "", {title: "Name of the sensor"}]
  - ["ts.unit", "i", 0, {title: "Display unit of the Sensor"}] # 0 - Celsius, 1 - Farenheit
  - ["ts.update_interval", "i", 1, {title: "Update Interval of the sensor in seconds, minimum 1s"}]
  - ["ts.offset", "i", 0, {title: "Offset value can be used for calibration in unit*100 e.g. centigrade"}]

  - ["sw", "o", {title: "Switch settings", abstract: true}]
  - ["sw.name", "s", "", {title: "Name of the switch"}]
  - ["sw.enable", "b", true, {title: "Enable this switch in the accessory"}]
  - ["sw.out_inverted", "b", false, {title: "Invert output, set to true for normally open output"}]
  - ["sw.in_mode", "i", 1, {title: "-1 - Absent, 0 - Momentary, 1 - Toggle, 2 - Edge, 3 - Detached"}]
  - ["sw.in_inverted", "b", false, {title: "Invert input, set to true for normally closed input"}]
  - ["sw.state", "b", false, {title: "State of the switch"}]
  - ["sw.svc_type", "i", 0, {title: "HAP service type, -1 = disable, 0 = switch, 1 = outlet, 2 = lock, 3 = valve"}]
  - ["sw.hk_state_inverted", "b", false, {title: "Invert switch state in HomeKit, for switch and outlet only"}]
  - ["sw.valve_type", "i", 1, {title: "HAP valve type (if svc is 3), -1 = disable, 0 = GenericValve, 1 = Irrigation"}] # see for details about non supported types https://github.com/mongoose-os-apps/shelly-homekit/issues/510
  - ["sw.initial_state", "i", 3, {title: "Initial state on power-on: 0 - off, 1 - on, 2 - restore last state, 3 - matches input if in toggle mode, otherwise off"}]
  - ["sw.auto_off", "b", false, {title: "Whether the switch should automatically turn OFF after turning ON"}]
  - ["sw.auto_off_delay", "d", 0, {title: "Delay for automatically turning OFF, in seconds"}]
  - ["sw.state_led_en", "i", -1, {title: "State LED: -1 - unsupported by device, 0 - off, 1 - on"}]

  - ["in", "o", {title: "Detached Input settings", abstract: true}]
  - ["in.type", "i", 3, {title: "HAP service type, 3 - Stateless switch, 7 - Motion sensor, 8 - Occupancy sensor, 6 - Disabled"}]
  - ["in.inverted", "b", false, {title: "Invert input, set to true for normally closed input"}]
  - ["in.ssw", "o", {title: "Stateless Switch settings"}]
  - ["in.ssw.name", "s", "", {title: "Name of the switch"}]
  - ["in.ssw.in_mode", "i", 0, {title: "0 - Momentary; 1 - Toggle, single press event on change; 2 - Toggle, on = single press, off = double press"}]
  - ["in.sensor", "o", {title: "Motion Sensor settings"}]
  - ["in.sensor.name", "s", "", {title: "Name of the sensor"}]
  - ["in.sensor.in_mode", "i", 0, {title: "0 - Level, 1 - Pulse"}]
  - ["in.sensor.idle_time", "i", 15, {title: "In pulse mode, go back to 'no motion' after no pulse received within this interval"}]

  - ["wc", "o", {title: "Roller shutter settings", abstract: true}]
  - ["wc.name", "s", "Shutter 1", {title: "Accessory name"}]
  - ["wc.in_mode", "i", 0, {title: "Input mode: 0 - separate, momentary; 0 - separate, toggle; 2 - single, momentary; 3 - detached"}]
  - ["wc.swap_inputs", "b", false, {title: "Swap inputs (2 - open, 1 - close)"}]
  - ["wc.swap_outputs", "b", false, {title: "Swap outputs (2 - open, 1 - close)"}]
  - ["wc.calibrated", "b", false, {title: "Calibration done"}]
  - ["wc.idle_power_thr", "f", 5.0, {title: "Power consumption threshold for motor idle detection"}]
  - ["wc.move_power", "f", 0.0, {title: "Power consumption during movement, watts"}]
  - ["wc.move_time_ms", "i", 0, {title: "Move time, in millseconds"}]
  - ["wc.max_ramp_up_time_ms", "i", 5000, {title: "Maximum ramp up time, in millseconds"}]
  - ["wc.obstruction_power_coeff", "f", 2.5, {title: "How much power consumption vs average is too much?"}]
  - ["wc.obstruction_duration_ms", "i", 3000, {title: "How long should the overpower persist for obstruction to be reported?"}]
  - ["wc.obstruction_time_coeff", "f", 1.5, {title: "How long is too long (compared to max)?"}]
  - ["wc.current_pos", "f", 0.0, {title: "Last position, percent: 0 - fully closed, 100 - fully open."}]

  - ["gdo", "o", {title: "Garage door settings", abstract: true}]
  - ["gdo.name", "s", "Garage Door", {title: "Accessory name"}]
  - ["gdo.sensor_swap", "b", false, {title: "Whether to swap the two input sensors"}]
  - ["gdo.close_sensor_mode", "i", 0, {title: "Close sensor mode: 0 - normally closed, 1 - normally open"}]
  - ["gdo.open_sensor_mode", "i", 0, {title: "Close sensor mode: 0 - normally closed, 1 - normally open, 2 - disabled"}]
  - ["gdo.out_mode", "i", 0, {title: "Output mode: 0 - single (open=close=1), 1 - dual (1=open, 2=close), 2 - single inverted (open=close=1)"}]
  - ["gdo.move_time_ms", "i", 30000, {title: "Movement time, ms"}]
  - ["gdo.begin_move_time_ms", "i", 7000, {title: "Time allowed for movement to begin, ms"}]
  - ["gdo.pulse_time_ms", "i", 300, {title: "Output active time, ms"}]

  - ["lb", "o", {title: "Light bulb settings", abstract: true}]
  - ["lb.name", "s", "Light bulb", {title: "Accessory name"}]
  - ["lb.svc_hidden", "b", false, {title: "Whether HAP service is hidden"}]
  - ["lb.enable", "b", true, {title: "Enable this light in the accessory"}]
  - ["lb.in_mode", "i", 1, {title: "-1 - Absent, 0 - Momentary, 1 - Toggle, 2 - Edge, 3 - Detached"}]
  - ["lb.in_inverted", "b", false, {title: "Invert input, set to true for normally closed input"}]
  - ["lb.state", "b", false, {title: "State of the light"}]
  - ["lb.hue", "i", 0, {title: "Hue of the light"}]
  - ["lb.brightness", "i", 100, {title: "Brightness of the light"}]
  - ["lb.saturation", "i", 100, {title: "Saturation of the light"}]
  - ["lb.color_temperature", "i", 400, {title: "Color Temperature of the light"}]
  - ["lb.initial_state", "i", 3, {title: "Initial state on power-on: 0 - off, 1 - on, 2 - restore last state, 3 - matches input if in toggle mode, otherwise off"}]
  - ["lb.auto_off", "b", false, {title: "Whether the switch should automatically turn OFF after turning ON"}]
  - ["lb.auto_off_delay", "d", 0, {title: "Delay for automatically turning OFF, in seconds"}]
  - ["lb.transition_time", "i", 2000, {title: "Time in milliseconds how long a transition will take"}]

  - ["_const.rpc_acl", "s", '[{"ch_type": "UART", "acl": "*"},{"method": "Shelly.GetInfo", "acl": "*"},{"method": "*", "ch_type": "HTTP", "acl": "admin"},{"method": "*", "ch_type": "WS_in", "acl": "admin"}]', {}]

  # Preserved from stock.
  - ["k_apparent", "i", 1750000, {}]
  - ["max_power", "i", 1800, {}]

  # Deprecated settings, only kept to enable migration.
  - ["sw.persist_state", "b", false, {}]  # Since cfg v1
  - ["ssw", "o", {abstract: true}]
  - ["ssw.name", "s", "", {}]
  - ["ssw.in_mode", "i", 0, {}]

  #abstract for calibration type
  - ["gains", "o", {title: "", abstract: true}]
  - ["gains.avgain", "f", 4194304, {title: ""}] #default register values are 0x40000
  - ["gains.aigain", "f", 4194304, {title: ""}]
  - ["gains.awgain", "f", 4194304, {title: ""}]
  - ["gains.phcala", "f", 0, {title: "Sign magnitude 10bit value. register is 16 bit, value coming from cal seems to have sign in 22 bit (1 << 22)"}]
  - ["gains.bvgain", "f", 4194304, {title: ""}]
  - ["gains.bigain", "f", 4194304, {title: ""}]
  - ["gains.bwgain", "f", 4194304, {title: ""}]
  - ["gains.phcalb", "f", 0, {title: ""}]

  - ["scales", "o", {title: "", abstract: true}]
  - ["scales.voltage_scale", "f", 0, {title: ""}]
  - ["scales.current_scale", "f", 0, {title: ""}]
  - ["scales.aenergy_scale", "f", 0, {title: ""}]
  - ["scales.apower_scale",  "f", 0, {title: ""}]
  - ["scales.current_gain", "f", 0, {title: ""}]  

build_vars:
  # BLE disabled for most models.
  MGOS_HAP_BLE: 0
  # Enables storing setup info in the config and a simple RPC service to configure it.
  MGOS_HAP_SIMPLE_CONFIG: 1
  MGOS_FW_EXTRA_ATTRS: shelly_hk_model=${build_vars.MODEL}

cdefs:
  PRODUCT_VENDOR: Allterco
  PRODUCT_MODEL: ${build_vars.MODEL}
  LED_GPIO: -1
  LED_ON: 0
  BTN_GPIO: -1
  BTN_DOWN: 0
  BTN_NOISY: 1
  RST_GPIO_INIT: -1
  SHELLY_HAVE_DUAL_INPUT_MODES: 0
  MAX_NUM_HAP_SESSIONS: 12

libs:
  - location: ./libreset
  - location: https://github.com/markirb/core
  - location: https://github.com/mongoose-os-libs/file-logger
  - location: https://github.com/mongoose-os-libs/homekit-adk
  - location: https://github.com/mongoose-os-libs/http-server
  - location: https://github.com/mongoose-os-libs/ota-http-server
  - location: https://github.com/mongoose-os-libs/rpc-service-config
  - location: https://github.com/mongoose-os-libs/rpc-service-fs
  - location: https://github.com/mongoose-os-libs/rpc-uart
  - location: https://github.com/mongoose-os-libs/rpc-ws
  - location: https://github.com/mongoose-os-libs/sntp
  # Not enough space on 2.5
  # - location: https://github.com/mongoose-os-libs/rpc-mqtt
  # - location: https://github.com/mongoose-os-libs/rpc-service-ota
  # For testing GPIOs:
  # - location: https://github.com/mongoose-os-libs/rpc-service-gpio

conds:
  - when: mos.platform == "esp32c3"
    apply:
      libs:
        - location: https://github.com/markirb/adc
  - when: mos.platform == "esp32"
    apply:
      libs:
        - location: https://github.com/mongoose-os-libs/adc
        - location: https://github.com/shelly-homekit-mos/pwm

  - when: mos.platform == "esp8266"
    apply:
      libs:
        - location: https://github.com/mongoose-os-libs/adc
        - location: https://github.com/shelly-homekit-mos/pwm

  - when: mos.platform != "ubuntu"
    apply:
      sources:
        - src/noisy_input_pin
        - src/wifi_config
      config_schema:
        - ["wifi.ap.pass", ""]
        - ["wifi.ap.ip", "192.168.33.1"]
        - ["wifi.ap.gw", ""]
        - ["wifi.ap.dhcp_start", "192.168.33.2"]
        - ["wifi.ap.dhcp_end", "192.168.33.100"]
        - ["wifi.sta_connect_timeout", 15]
        - ["wifi.sta_roam_rssi_thr", -80]
        - ["wifi.sta_roam_interval", 600]
        - ["wifi.ap.keep_enabled", "b", false, {title: "Keep WiFi AP enabled even when STA is connected"}]
        # This is a mitigation for devices dropping of wifi and never coming back.
        # This is believed to be fixed, default has been flipped back to 0 in 2.11.0.
        # Consider removing in later releases.
        - ["shelly.wifi_connect_reboot_timeout", "i", 0, {title: "If not connected for this long when supposed to be, reboot"}]
      libs:
        - location: https://github.com/mongoose-os-libs/wifi
      cdefs:
        # Size fine-tuning, saves substantial amount of RAM vs defaults.
        HAP_SESSION_SIZE: 392
        HAP_IP_SESSION_SIZE: 600
        # XXX: fix size calculation with and without BLE
        XHAP_ACCESSORY_SERVER_SIZE: 1680
        HAP_LOG_LEVEL: 0             # This saves 36K on esp8266.
        HAP_TLV_NO_LOG: 1            # Saves us stack
        HAP_DISABLE_ASSERTS: 1       # 32K
        HAP_DISABLE_PRECONDITIONS: 1 # 40K

  - when: mos.platform == "esp32"
    apply:
      config_schema:
        - ["wifi.sta_ps_mode", 1]
      build_vars:
        MGOS_ROOT_FS_TYPE: LFS
        MGOS_ROOT_FS_SIZE: 0x60000
        APP_SLOT_SIZE: 0x190000

  - when: build_vars.MODEL == "Shelly1"
    apply:
      name: switch1 # To allow OTA from stock fw.
      sources:
        - src/DS18XXX
        - src/DHT
      libs:
        - location: https://github.com/mongoose-os-libs/onewire
        - location: https://github.com/mongoose-os-libs/dht
        - location: https://github.com/mongoose-os-libs/mongoose
          variant: esp8266-nossl
      build_vars:
        FLASH_SIZE: 2097152
        FS_SIZE: 262144
        BOOT_CONFIG_ADDR: 0x1000  # To be compatible with stock firmware.
        MGOS_ROOT_FS_TYPE: SPIFFS
      cdefs:
        PRODUCT_HW_REV: "1.0"
        STOCK_FW_MODEL: SHSW-1
        # We don't use SSL, HomeKit uses its own crypto. This saves ~120K.
        MG_ENABLE_SSL: 0
      config_schema:
        - ["device.id", "shelly1-??????"]
        - ["shelly.name", "shelly1-??????"]
        - ["wifi.ap.ssid", "shelly1-??????"]
        - ["ts1", "ts", {title: "TS1 settings"}]
        - ["ts1.name", "Shelly TS1"]
        - ["ts2", "ts", {title: "TS2 settings"}]
        - ["ts2.name", "Shelly TS2"]
        - ["ts3", "ts", {title: "TS3 settings"}]
        - ["ts3.name", "Shelly TS3"]
        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "Shelly SW"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Shelly SSW2"]
        - ["in2.sensor.name", "Shelly S2"]
        - ["gdo1", "gdo", {title: "GDO1 settings"}]
        - ["gdo1.name", "Garage Door"]
        - ["gdo1.open_sensor_mode", 2]
        # Only for backward compatibility (config <= v3).
        - ["ssw1", "ssw", {title: "SSW1 settings"}]
        - ["ssw1.name", "Input"]

  - when: build_vars.MODEL == "Shelly1L"
    apply:
      name: switch1l # To allow OTA from stock fw.
      libs:
        - location: https://github.com/mongoose-os-libs/mongoose
          variant: esp8266-nossl
      sources:
        - src/BL0937
      build_vars:
        FLASH_SIZE: 2097152
        FS_SIZE: 262144
        BOOT_CONFIG_ADDR: 0x1000  # To be compatible with stock firmware.
        MGOS_ROOT_FS_TYPE: SPIFFS
      cdefs:
        LED_GPIO: 0
        LED_ON: 0
        BTN_GPIO: 13
        BTN_DOWN: 0
        PRODUCT_HW_REV: "1.0"
        STOCK_FW_MODEL: SHSW-L
        # We don't use SSL, HomeKit uses its own crypto. This saves ~120K.
        MG_ENABLE_SSL: 0
        SHELLY_HAVE_DUAL_INPUT_MODES: 1
      config_schema:
        - ["device.id", "shelly1l-??????"]
        - ["shelly.name", "shelly1l-??????"]
        - ["wifi.ap.ssid", "shelly1l-??????"]
        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "Shelly SW"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Shelly SSW2"]
        - ["in2.sensor.name", "Shelly S2"]
        # Only for backward compatibility (config <= v3).
        - ["ssw1", "ssw", {title: "SSW1 settings"}]
        - ["ssw1.name", "Input 1"]
        - ["ssw2", "ssw", {title: "SSW2 settings"}]
        - ["ssw2.name", "Input 2"]

  - when: build_vars.MODEL == "Shelly1PM"
    apply:
      name: switch1pm # To allow OTA from stock fw.
      sources:
        - src/DS18XXX
        - src/DHT
        - src/BL0937
      libs:
        - location: https://github.com/mongoose-os-libs/onewire
        - location: https://github.com/mongoose-os-libs/dht
        - location: https://github.com/mongoose-os-libs/mongoose
          variant: esp8266-nossl
      build_vars:
        FLASH_SIZE: 2097152
        FS_SIZE: 262144
        BOOT_CONFIG_ADDR: 0x1000  # To be compatible with stock firmware.
        MGOS_ROOT_FS_TYPE: SPIFFS
      cdefs:
        LED_GPIO: 0
        LED_ON: 0
        BTN_GPIO: 2
        BTN_DOWN: 0
        PRODUCT_HW_REV: "1.0"
        STOCK_FW_MODEL: SHSW-PM
        # We don't use SSL, HomeKit uses its own crypto. This saves ~120K.
        MG_ENABLE_SSL: 0
      config_schema:
        - ["device.id", "shelly1pm-??????"]
        - ["shelly.name", "shelly1pm-??????"]
        - ["wifi.ap.ssid", "shelly1pm-??????"]
        - ["sw1", "sw", {title: "SW settings"}]
        - ["sw1.name", "Shelly SW"]
        - ["ts1", "ts", {title: "TS1 settings"}]
        - ["ts1.name", "Shelly TS1"]
        - ["ts2", "ts", {title: "TS2 settings"}]
        - ["ts2.name", "Shelly TS2"]
        - ["ts3", "ts", {title: "TS3 settings"}]
        - ["ts3.name", "Shelly TS3"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Shelly SSW2"]
        - ["in2.sensor.name", "Shelly S2"]
        - ["gdo1", "gdo", {title: "GDO1 settings"}]
        - ["gdo1.name", "Garage Door"]
        - ["gdo1.open_sensor_mode", 2]
        - ["bl0937.power_coeff", "f", 0, {title: "BL0937 counts -> watts conversion coefficient"}]
        - ["bl0937.power_coeff", 1.79942025]  # (16 + 1010 + 1935) / (8.53 + 561 + 1076)
        # Only for backward compatibility (config <= v3).
        - ["ssw1", "ssw", {title: "SSW1 settings"}]
        - ["ssw1.name", "Input"]

  - when: build_vars.MODEL == "Shelly2"
    apply:
      name: switch
      libs:
        - location: https://github.com/mongoose-os-libs/mongoose
          variant: esp8266-nossl
      build_vars:
        FLASH_SIZE: 2097152
        FS_SIZE: 262144
        BOOT_CONFIG_ADDR: 0x1000
        MGOS_ROOT_FS_TYPE: SPIFFS
      cdefs:
        PRODUCT_HW_REV: "1.0"
        STOCK_FW_MODEL: SHSW-21
        MG_ENABLE_SSL: 0
      config_schema:
        - ["device.id", "shellyswitch21-??????"]
        - ["shelly.name", "shellyswitch21-??????"]
        - ["wifi.ap.ssid", "shellyswitch21-??????"]
        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "Shelly SW1"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["sw2", "sw", {title: "SW2 settings"}]
        - ["sw2.name", "Shelly SW2"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Shelly SSW2"]
        - ["in2.sensor.name", "Shelly S2"]
        - ["gdo1", "gdo", {title: "GDO1 settings"}]
        - ["gdo1.name", "Garage Door"]
        # Only for backward compatibility (config <= v3).
        - ["ssw1", "ssw", {title: "SSW1 settings"}]
        - ["ssw1.name", "Input 1"]
        - ["ssw2", "ssw", {title: "SSW2 settings"}]
        - ["ssw2.name", "Input 2"]

  - when: build_vars.MODEL == "Shelly25"
    apply:
      name: switch25
      sources:
        - src/ADE7953
      includes:
        - src/ADE7953
      libs:
        - location: https://github.com/mongoose-os-libs/mongoose
          variant: esp8266-nossl
        - location: https://github.com/mongoose-os-libs/ade7953
      build_vars:
        FLASH_SIZE: 2097152
        FS_SIZE: 262144
        BOOT_CONFIG_ADDR: 0x1000
        MGOS_ROOT_FS_TYPE: SPIFFS
      cdefs:
        LED_GPIO: 0
        LED_ON: 0
        BTN_GPIO: 2
        BTN_DOWN: 0
        PRODUCT_HW_REV: "2.5"
        STOCK_FW_MODEL: SHSW-25
        MG_ENABLE_SSL: 0
        SHELLY_HAVE_PM: 1
      config_schema:
        - ["device.id", "shellyswitch25-??????"]
        - ["shelly.name", "shellyswitch25-??????"]
        - ["wifi.ap.ssid", "shellyswitch25-??????"]
        - ["i2c.enable", true]
        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "Shelly SW1"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["sw2", "sw", {title: "SW2 settings"}]
        - ["sw2.name", "Shelly SW2"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Shelly SSW2"]
        - ["in2.sensor.name", "Shelly S2"]
        - ["wc1", "wc", {title: "WC1 settings"}]
        - ["wc1.name", "Window 1"]
        - ["gdo1", "gdo", {title: "GDO1 settings"}]
        - ["gdo1.name", "Garage Door"]
        # Only for backward compatibility (config <= v3).
        - ["ssw1", "ssw", {title: "SSW1 settings"}]
        - ["ssw1.name", "Input 1"]
        - ["ssw2", "ssw", {title: "SSW2 settings"}]
        - ["ssw2.name", "Input 2"]

  - when: build_vars.MODEL == "ShellyColorBulb"
    apply:
      name: color-bulb # To allow OTA from stock fw.
      libs:
        - origin: https://github.com/mongoose-os-libs/mongoose
          variant: esp8266-nossl
      build_vars:
        FLASH_SIZE: 2097152
        FS_SIZE: 262144
        BOOT_CONFIG_ADDR: 0x1000  # To be compatible with stock firmware.
        MGOS_ROOT_FS_TYPE: SPIFFS
      cdefs:
        PWM_SUPPORT: 1
        PRODUCT_HW_REV: "1.0"
        STOCK_FW_MODEL: SHCB-1
        # We don't use SSL, HomeKit uses its own crypto. This saves ~120K.
        MG_ENABLE_SSL: 0
      config_schema:
        - ["shelly.mode", 4] # 4 - RGBW"
        - ["device.id", "shellycolorbulb-??????"]
        - ["shelly.name", "shellycolorbulb-??????"]
        - ["wifi.ap.ssid", "shellycolorbulb-??????"]
        - ["lb1", "lb", {title: "RGBW "}]
        - ["lb1.initial_state", 2] # last

  - when: build_vars.MODEL == "ShellyDuo"
    apply:
      name: bulbduo # To allow OTA from stock fw.
      libs:
        - origin: https://github.com/mongoose-os-libs/mongoose
          variant: esp8266-nossl
      build_vars:
        FLASH_SIZE: 2097152
        FS_SIZE: 262144
        MGOS_ROOT_FS_TYPE: SPIFFS
      cdefs:
        PRODUCT_HW_REV: "1.0"
        STOCK_FW_MODEL: SHBDUO-1
        # We don't use SSL, HomeKit uses its own crypto. This saves ~120K.
        MG_ENABLE_SSL: 0
      config_schema:
        - ["device.id", "ShellyBulbDuo-??????"]
        - ["shelly.name", "ShellyBulbDuo-??????"]
        - ["wifi.ap.ssid", "ShellyBulbDuo-??????"]
        - ["lb1", "lb", {title: "Light bulb settings"}]
        - ["lb1.initial_state", 2] # last

  - when: build_vars.MODEL == "ShellyI3"
    apply:
      name: ix3
      libs:
        - location: https://github.com/mongoose-os-libs/mongoose
          variant: esp8266-nossl
      build_vars:
        FLASH_SIZE: 2097152
        FS_SIZE: 262144
        BOOT_CONFIG_ADDR: 0x1000
        MGOS_ROOT_FS_TYPE: SPIFFS
      cdefs:
        PRODUCT_HW_REV: "1.0"
        STOCK_FW_MODEL: SHIX3-1
        MG_ENABLE_SSL: 0
        LED_GPIO: 5
        LED_ON: 0
        BTN_GPIO: 4
        BTN_DOWN: 0
      config_schema:
        - ["device.id", "shellyix3-????????????"]
        - ["wifi.ap.ssid", "shellyix3-????????????"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Input 1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Input 2"]
        - ["in2.sensor.name", "Shelly S2"]
        - ["in3", "in", {title: "Input 3 settings"}]
        - ["in3.ssw.name", "Input 3"]
        - ["in3.sensor.name", "Shelly S3"]
        # Only for backward compatibility (config <= v3).
        - ["ssw1", "ssw", {title: "SSW1 settings"}]
        - ["ssw1.name", "Input 1"]
        - ["ssw2", "ssw", {title: "SSW2 settings"}]
        - ["ssw2.name", "Input 2"]
        - ["ssw3", "ssw", {title: "SSW3 settings"}]
        - ["ssw3.name", "Input 3"]

  # Note this is also known as "ShellyPlug 2", as opposed to the original Plug
  # which was based on CC3200. However, that one is long gone and we can ignore it.
  - when: build_vars.MODEL == "ShellyPlug"
    apply:
      name: shelly-plug2 # To allow OTA from stock fw.
      sources:
        - src/BL0937
      libs:
        - location: https://github.com/mongoose-os-libs/mongoose
          variant: esp8266-nossl
      build_vars:
        # Note: 4 MB flash chip
        FS_SIZE: 262144
        MGOS_ROOT_FS_TYPE: SPIFFS
      cdefs:
        LED_GPIO: 13  # Green, 14 red, 16 blue.
        LED_ON: 0
        BTN_GPIO: 12
        BTN_DOWN: 1
        PRODUCT_HW_REV: "1.0"
        STOCK_FW_MODEL: SHPLG2-1
        MG_ENABLE_SSL: 0
      config_schema:
        - ["device.id", "shellyplug-??????"]
        - ["shelly.name", "shellyplug-??????"]
        - ["wifi.ap.ssid", "shellyplug-??????"]
        - ["sw1", "sw", {title: "Plug settings"}]
        - ["sw1.name", "Shelly Plug"]
        - ["sw1.in_mode", -1]
        - ["sw1.svc_type", 1]  # Outlet
        - ["sw1.initial_state", 2]
        - ["bl0937.power_coeff", "f", 0, {title: "BL0937 counts -> watts conversion coefficient"}]
        - ["bl0937.power_coeff", 8.59980831]  # (16 + 1010 + 1935) / (2.01 + 117.3 + 225)

  - when: build_vars.MODEL == "ShellyPlugS"
    apply:
      name: shelly-plug-s # To allow OTA from stock fw.
      sources:
        - src/BL0937
      libs:
        - location: https://github.com/mongoose-os-libs/mongoose
          variant: esp8266-nossl
      build_vars:
        FLASH_SIZE: 2097152
        FS_SIZE: 262144
        BOOT_CONFIG_ADDR: 0x7000  # To be compatible with stock firmware.
        MGOS_ROOT_FS_TYPE: SPIFFS
      cdefs:
        LED_GPIO: 2  # Blue, 0 red.
        LED_ON: 0
        BTN_GPIO: 13
        BTN_DOWN: 0
        PRODUCT_HW_REV: "1.0"
        STOCK_FW_MODEL: SHPLG-S
        MG_ENABLE_SSL: 0
      config_schema:
        - ["device.id", "shellyplug-s-??????"]
        - ["shelly.name", "shellyplug-s-??????"]
        - ["wifi.ap.ssid", "shellyplug-s-??????"]
        - ["sw1", "sw", {title: "Plug settings"}]
        - ["sw1.name", "Shelly Plug S"]
        - ["sw1.in_mode", -1]
        - ["sw1.svc_type", 1]  # Outlet
        - ["sw1.initial_state", 2]
        - ["sw1.state_led_en", 1]
        - ["bl0937.power_coeff", "f", 0, {title: "BL0937 counts -> watts conversion coefficient"}]
        - ["bl0937.power_coeff", 1.64358469]  # (16 + 1010 + 1935) / (9.55 + 617 + 1175)

  - when: build_vars.MODEL == "ShellyPlusPlugS"
    apply:
      name: PlusPlugS
      sources:
        - src/BL0937
      build_vars:
        ESP_IDF_EXTRA_PARTITION: "aux,0x55,0x00,0x3f0000,48K"
        ESP_IDF_EXTRA_PARTITION_2: "shelly,data,0x88,0x3fc000,16K,encrypted"
        ESP_IDF_SDKCONFIG_OPTS: >
          ${build_vars.ESP_IDF_SDKCONFIG_OPTS}
            CONFIG_FREERTOS_UNICORE=y
            CONFIG_ESPTOOLPY_FLASHMODE_DIO=y
      libs:
        - location: https://github.com/mongoose-os-libs/neopixel
      cdefs:
        LED_GPIO: 25
        LED_ON: 1
        BTN_GPIO: 9
        BTN_DOWN: 0
        RELAY_GPIO: 4
        NEOPX_GPIO: 25
        NEOPX1_GPIO: 26
        ADC_GPIO: 33
        PRODUCT_HW_REV: "2.0.0"
        STOCK_FW_MODEL: PlusPlugS
        MAX_NUM_HAP_SESSIONS: 16
      config_schema:
        - ["device.id",    "shellyplusplug-s-????????????"]
        - ["shelly.name",  "shellyplusplug-s-????????????"]
        - ["wifi.ap.ssid", "shellyplusplug-s-????????????"]
        - ["sw1", "sw", {title: "Plug settings"}]
        - ["sw1.name", "Shelly Plus Plug S"]
        - ["sw1.in_mode", -1]
        - ["sw1.svc_type", 1]  # Outlet
        - ["sw1.initial_state", 2]
        - ["sw1.state_led_en", 1]
        - ["bl0937.power_coeff", "f", 0, {title: "BL0937 counts -> watts conversion coefficient"}]
        - ["bl0937.power_coeff", 1.64358469]  # (16 + 1010 + 1935) / (9.55 + 617 + 1175)
        - ["led.color_on", "i", 0x0000FF, {title: "LED color when on"}]
        - ["led.color_off", "i", 0x000000, {title: "LED color when off"}]

  - when: build_vars.MODEL == "ShellyPlusRGBWPM"
    apply:
      name: PlusRGBWPM
      libs:
        - location: https://github.com/mongoose-os-libs/mongoose
      sources:
        - src/ShellyRGBW2
      build_vars:
        ESP_IDF_EXTRA_PARTITION: "aux,0x55,0x00,0x3f0000,48K"
        ESP_IDF_EXTRA_PARTITION_2: "shelly,data,0x88,0x3fc000,16K,encrypted"
        ESP_IDF_SDKCONFIG_OPTS: >
          ${build_vars.ESP_IDF_SDKCONFIG_OPTS}
            CONFIG_FREERTOS_UNICORE=y
            CONFIG_ESPTOOLPY_FLASHMODE_DIO=y
      cdefs:
        LED_GPIO: 14
        LED_ON: 0
        BTN_GPIO: 22
        BTN_DOWN: 1
        GPIO_R: 25
        GPIO_G: 26
        GPIO_B: 27
        GPIO_W: 4
        GPIO_I1: 36
        GPIO_I2: 37
        GPIO_I3: 38
        GPIO_I4: 39
        PRODUCT_HW_REV: "0.1.6"
        STOCK_FW_MODEL: PlusRGBWPM
        MAX_NUM_HAP_SESSIONS: 16
      config_schema:
        - ["device.id",    "ShellyPlusRGBWPM-????????????"]
        - ["shelly.name",  "ShellyPlusRGBWPM-????????????"]
        - ["wifi.ap.ssid", "ShellyPlusRGBWPM-????????????"]

        - ["lb1", "lb", {title: "Light 1 settings"}]
        - ["lb2", "lb", {title: "Light 2 settings"}]
        - ["lb3", "lb", {title: "Light 3 settings"}]
        - ["lb4", "lb", {title: "Light 4 settings"}]

        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Shelly SSW2"]
        - ["in2.sensor.name", "Shelly S2"]
        - ["in3", "in", {title: "Input 3 settings"}]
        - ["in3.ssw.name", "Shelly SSW3"]
        - ["in3.sensor.name", "Shelly S3"]
        - ["in4", "in", {title: "Input 4 settings"}]
        - ["in4.ssw.name", "Shelly SSW4"]
        - ["in4.sensor.name", "Shelly S4"]

        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "Shelly SW1"]
        - ["sw2", "sw", {title: "SW2 settings"}]
        - ["sw2.name", "Shelly SW2"]
        - ["sw3", "sw", {title: "SW3 settings"}]
        - ["sw3.name", "Shelly SW3"]
        - ["sw4", "sw", {title: "SW4 settings"}]
        - ["sw4.name", "Shelly SW4"]

  - when: build_vars.MODEL == "ShellyPlus1PMMini"
    apply:
      name: Plus1PMMini
      sources:
        - src/ShellyMini1PMGen3
        - src/BL0942
      libs:
        - location: https://github.com/mongoose-os-libs/mongoose
      build_vars:
        MGOS_ROOT_FS_SIZE: 0x60000
        APP_SLOT_SIZE: 0x190000
        ESP_IDF_EXTRA_PARTITION: "aux,0x55,0x00,0x3f0000,48K"
        ESP_IDF_EXTRA_PARTITION_2: "shelly,data,0x88,0x3fc000,16K,encrypted"
        ESP_IDF_SDKCONFIG_OPTS: >
          ${build_vars.ESP_IDF_SDKCONFIG_OPTS}
            CONFIG_FREERTOS_UNICORE=y
            CONFIG_ESPTOOLPY_FLASHMODE_DIO=y
            CONFIG_PARTITION_TABLE_CUSTOM_FILENAME=\"../esp32xx/partitions_mgos.csv\"
            CONFIG_PARTITION_TABLE_FILENAME=\"../esp32xx/partitions_mgos.csv\"
      cdefs:
        LED_GPIO: 0
        LED_ON: 0
        BTN_GPIO: 1
        BTN_DOWN: 0
        PRODUCT_HW_REV: "0.1.0"
        STOCK_FW_MODEL: Plus1PMMini
        MAX_NUM_HAP_SESSIONS: 16
        MGOS_CONFIG_DEV_6: "shelly"
        MGOS_CONFIG_DEV_7: "shelly,4096"
      config_schema:
        - ["device.id",    "ShellyPlus1PMMini-????????????"]
        - ["shelly.name",  "ShellyPlus1PMMini-????????????"]
        - ["wifi.ap.ssid", "ShellyPlus1PMMini-????????????"]
        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "Shelly SW"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["gdo1", "gdo", {title: "GDO1 settings"}]
        - ["gdo1.name", "Garage Door"]
        - ["gdo1.open_sensor_mode", 2]

        - ["factory", "o", {title: ""}]
        - ["factory.batch", "s", "", {title: ""}]
        - ["factory.model", "s", "", {title: ""}]
        - ["factory.version", "i", 0, {title: ""}]
        - ["factory.calib", "o", {title: "Factory calib settings"}]
        - ["factory.calib.done", "b", false, {title: ""}]
        - ["factory.calib.scales0", "scales", {title: ""}]

  - when: build_vars.MODEL == "Shelly1Gen3"
    apply:
      name: S1G3
      sources:
        - src/DS18XXX
        - src/DHT
        - src/ShellyPlus1
      libs:
        - location: https://github.com/mongoose-os-libs/onewire
        - location: https://github.com/mongoose-os-libs/dht
        - location: https://github.com/mongoose-os-libs/mongoose
      build_vars:
        OTA_DATA_ADDR: 0x10000
        OTA_DATA_SIZE: 0x4000
        NVS_ADDR: 0x14000
        NVS_SIZE: 0xC000
        APP_OFFSET: 0x20000
        APP_SLOT_SIZE: 0x280000
        MGOS_ROOT_FS_TYPE: LFS
        MGOS_ROOT_FS_SIZE: 1048576
        ESP_IDF_EXTRA_PARTITION: "scratch,data,0x80,0x720000,0x80000,encrypted"
        ESP_IDF_EXTRA_PARTITION_2: "shelly,data,0x88,0x7F0000,64K,encrypted"
        ESP_IDF_SDKCONFIG_OPTS: >
          ${build_vars.ESP_IDF_SDKCONFIG_OPTS}
            CONFIG_FREERTOS_UNICORE=y
            CONFIG_ESPTOOLPY_FLASHMODE_DIO=y
            CONFIG_ESPTOOLPY_FLASHSIZE_8MB=y
      cdefs:
        LED_GPIO: 19
        LED_ON: 0
        BTN_GPIO: -1
        BTN_DOWN: 0
        PRODUCT_HW_REV: "??"
        STOCK_FW_MODEL: S1G3
        MAX_NUM_HAP_SESSIONS: 16
        RELAY1_GPIO: 5
        SWITCH1_GPIO: 10
        ADC_GPIO: 3
        ADDON_OUT_GPIO: 9
        ADDON_IN_GPIO: 21
        ADDON_DIG_GPIO: 6
      config_schema:
        - ["device.id",    "Shelly1G3-????????????"]
        - ["shelly.name",  "Shelly1G3-????????????"]
        - ["wifi.ap.ssid", "Shelly1G3-????????????"]
        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "Shelly SW"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Shelly SSW2"]
        - ["in2.sensor.name", "Shelly S2"]
        - ["gdo1", "gdo", {title: "GDO1 settings"}]
        - ["gdo1.name", "Garage Door"]
        - ["gdo1.open_sensor_mode", -1]
        
        - ["ts1", "ts", {title: "TS1 settings"}]
        - ["ts1.name", "Shelly TS1"]
        - ["ts2", "ts", {title: "TS2 settings"}]
        - ["ts2.name", "Shelly TS2"]
        - ["ts3", "ts", {title: "TS3 settings"}]
        - ["ts3.name", "Shelly TS3"]
        - ["ts4", "ts", {title: "TS4 settings"}]
        - ["ts4.name", "Shelly TS4"]
        - ["ts5", "ts", {title: "TS5 settings"}]
        - ["ts5.name", "Shelly TS5"]

  - when: build_vars.MODEL == "ShellyI4Gen3"
    apply:
      name: I4G3
      sources:
        - src/DS18XXX
        - src/DHT
        - src/ShellyPlusI4
      libs:
        - location: https://github.com/mongoose-os-libs/onewire
        - location: https://github.com/mongoose-os-libs/dht
        - location: https://github.com/mongoose-os-libs/mongoose
      build_vars:
        OTA_DATA_ADDR: 0x10000
        OTA_DATA_SIZE: 0x4000
        NVS_ADDR: 0x14000
        NVS_SIZE: 0xC000
        APP_OFFSET: 0x20000
        APP_SLOT_SIZE: 0x280000
        MGOS_ROOT_FS_TYPE: LFS
        MGOS_ROOT_FS_SIZE: 1048576
        ESP_IDF_EXTRA_PARTITION: "scratch,data,0x80,0x720000,0x80000,encrypted"
        ESP_IDF_EXTRA_PARTITION_2: "shelly,data,0x88,0x7F0000,64K,encrypted"
        ESP_IDF_SDKCONFIG_OPTS: >
          ${build_vars.ESP_IDF_SDKCONFIG_OPTS}
            CONFIG_FREERTOS_UNICORE=y
            CONFIG_ESPTOOLPY_FLASHMODE_DIO=y
            CONFIG_ESPTOOLPY_FLASHSIZE_8MB=y
      cdefs:
        LED_GPIO: -1
        LED_ON: 0
        BTN_GPIO: 4
        BTN_DOWN: 0
        PRODUCT_HW_REV: "??"
        STOCK_FW_MODEL: I4G3
        MAX_NUM_HAP_SESSIONS: 16
        SWITCH1_GPIO: 10
        SWITCH2_GPIO: 7
        SWITCH3_GPIO: 6
        SWITCH4_GPIO: 5
        ADC_GPIO: 3
        ADDON_OUT_GPIO: 9
        ADDON_IN_GPIO: 21
        ADDON_DIG_GPIO: -1
      config_schema:
        - ["device.id",    "ShellyI4G3-????????????"]
        - ["shelly.name",  "ShellyI4G3-????????????"]
        - ["wifi.ap.ssid", "ShellyI4G3-????????????"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Shelly SSW2"]
        - ["in2.sensor.name", "Shelly S2"]
        - ["in3", "in", {title: "Input 3 settings"}]
        - ["in3.ssw.name", "Shelly SSW3"]
        - ["in3.sensor.name", "Shelly S3"]
        - ["in4", "in", {title: "Input 4 settings"}]
        - ["in4.ssw.name", "Shelly SSW4"]
        - ["in4.sensor.name", "Shelly S4"]
        - ["ts1", "ts", {title: "TS1 settings"}]
        - ["ts1.name", "Shelly TS1"]
        - ["ts2", "ts", {title: "TS2 settings"}]
        - ["ts2.name", "Shelly TS2"]
        - ["ts3", "ts", {title: "TS3 settings"}]
        - ["ts3.name", "Shelly TS3"]
        - ["ts4", "ts", {title: "TS4 settings"}]
        - ["ts4.name", "Shelly TS4"]
        - ["ts5", "ts", {title: "TS5 settings"}]
        - ["ts5.name", "Shelly TS5"]

  - when: build_vars.MODEL == "ShellyPlugSGen3"
    apply:
      name: PlugSG3
      sources:
        - src/ShellyPlusPlugS
        - src/BL0942
      libs:
        - location: https://github.com/mongoose-os-libs/mongoose
        - location: https://github.com/mongoose-os-libs/neopixel
      build_vars:
        OTA_DATA_ADDR: 0x10000
        OTA_DATA_SIZE: 0x4000
        NVS_ADDR: 0x14000
        NVS_SIZE: 0xC000
        APP_OFFSET: 0x20000
        APP_SLOT_SIZE: 0x280000
        MGOS_ROOT_FS_TYPE: LFS
        MGOS_ROOT_FS_SIZE: 1048576
        ESP_IDF_EXTRA_PARTITION: "scratch,data,0x80,0x720000,0x80000,encrypted"
        ESP_IDF_EXTRA_PARTITION_2: "shelly,data,0x88,0x7F0000,64K,encrypted"
        ESP_IDF_SDKCONFIG_OPTS: >
          ${build_vars.ESP_IDF_SDKCONFIG_OPTS}
            CONFIG_FREERTOS_UNICORE=y
            CONFIG_ESPTOOLPY_FLASHMODE_DIO=y
            CONFIG_ESPTOOLPY_FLASHSIZE_8MB=y
      cdefs:
        LED_GPIO: -1
        LED_ON: 1
        BTN_GPIO: 18
        BTN_DOWN: 0
        RELAY_GPIO: 5
        NEOPX_GPIO: 4
        ADC_GPIO: 3
        UART_TX_GPIO: 6
        UART_RX_GPIO: 7
        PRODUCT_HW_REV: "?"
        STOCK_FW_MODEL: PlugSG3
        MAX_NUM_HAP_SESSIONS: 16
        MGOS_CONFIG_DEV_6: "shelly"
        MGOS_CONFIG_DEV_7: "shelly,4096"
      config_schema:
        - ["device.id",    "ShellyPlugSG3-????????????"]
        - ["shelly.name",  "ShellyPlugSG3-????????????"]
        - ["wifi.ap.ssid", "ShellyPlugSG3-????????????"]
        - ["sw1", "sw", {title: "Plug settings"}]
        - ["sw1.name", "Shelly Plus Plug S"]
        - ["sw1.in_mode", -1]
        - ["sw1.svc_type", 1]  # Outlet
        - ["sw1.initial_state", 2]
        - ["sw1.state_led_en", 1]
        - ["led.color_on", "i", 0x00FF00, {title: "LED color when on"}]
        - ["led.color_off", "i", 0xFF0000, {title: "LED color when off"}]

        - ["factory", "o", {title: ""}]
        - ["factory.batch", "s", "", {title: ""}]
        - ["factory.model", "s", "", {title: ""}]
        - ["factory.version", "i", 0, {title: ""}]
        - ["factory.calib", "o", {title: "Factory calib settings"}]
        - ["factory.calib.done", "b", false, {title: ""}]
        - ["factory.calib.scales0", "scales", {title: ""}]
  - when: build_vars.MODEL == "Shelly1PMGen3"
    apply:
      name: S1PMG3
      sources:
        - src/DS18XXX
        - src/DHT
        - src/ShellyPlus1PM
        - src/BL0942
      libs:
        - location: https://github.com/mongoose-os-libs/onewire
        - location: https://github.com/mongoose-os-libs/dht
        - location: https://github.com/mongoose-os-libs/mongoose
      build_vars:
        OTA_DATA_ADDR: 0x10000
        OTA_DATA_SIZE: 0x4000
        NVS_ADDR: 0x14000
        NVS_SIZE: 0xC000
        APP_OFFSET: 0x20000
        APP_SLOT_SIZE: 0x280000
        MGOS_ROOT_FS_TYPE: LFS
        MGOS_ROOT_FS_SIZE: 1048576
        ESP_IDF_EXTRA_PARTITION: "scratch,data,0x80,0x720000,0x80000,encrypted"
        ESP_IDF_EXTRA_PARTITION_2: "shelly,data,0x88,0x7F0000,64K,encrypted"
        ESP_IDF_SDKCONFIG_OPTS: >
          ${build_vars.ESP_IDF_SDKCONFIG_OPTS}
            CONFIG_FREERTOS_UNICORE=y
            CONFIG_ESPTOOLPY_FLASHMODE_DIO=y
            CONFIG_ESPTOOLPY_FLASHSIZE_8MB=y
      cdefs:
        LED_GPIO: 8
        LED_ON: 0
        BTN_GPIO: 1
        BTN_DOWN: 0
        PRODUCT_HW_REV: "??"
        STOCK_FW_MODEL: S1PMG3
        MAX_NUM_HAP_SESSIONS: 16
        RELAY1_GPIO: 4
        SWITCH1_GPIO: 10
        ADC_GPIO: 3
        ADDON_OUT_GPIO: 9
        ADDON_IN_GPIO: 21
        ADDON_DIG_GPIO: -1
        UART_TX_GPIO: 6
        UART_RX_GPIO: 7
        MGOS_CONFIG_DEV_6: "shelly"
        MGOS_CONFIG_DEV_7: "shelly,4096"
      config_schema:
        - ["device.id", "Shelly1PMG3-????????????"]
        - ["shelly.name", "Shelly1PMG3-????????????"]
        - ["wifi.ap.ssid", "Shelly1PMG3-????????????"]
        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "Shelly SW"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Shelly SSW2"]
        - ["in2.sensor.name", "Shelly S2"]
        - ["gdo1", "gdo", {title: "GDO1 settings"}]
        - ["gdo1.name", "Garage Door"]
        - ["gdo1.open_sensor_mode", -1]

        - ["ts1", "ts", {title: "TS1 settings"}]
        - ["ts1.name", "Shelly TS1"]
        - ["ts2", "ts", {title: "TS2 settings"}]
        - ["ts2.name", "Shelly TS2"]
        - ["ts3", "ts", {title: "TS3 settings"}]
        - ["ts3.name", "Shelly TS3"]
        - ["ts4", "ts", {title: "TS4 settings"}]
        - ["ts4.name", "Shelly TS4"]
        - ["ts5", "ts", {title: "TS5 settings"}]
        - ["ts5.name", "Shelly TS5"]

        - ["factory", "o", {title: ""}]
        - ["factory.batch", "s", "", {title: ""}]
        - ["factory.model", "s", "", {title: ""}]
        - ["factory.version", "i", 0, {title: ""}]
        - ["factory.calib", "o", {title: "Factory calib settings"}]
        - ["factory.calib.done", "b", false, {title: ""}]
        - ["factory.calib.scales0", "scales", {title: ""}]

  - when: build_vars.MODEL == "Shelly2PMGen3"
    apply:
      name: S2PMG3
      sources:
        - src/DS18XXX
        - src/DHT
        - src/ADE7953
        - src/ShellyPlus2PM
      includes:
        - src/ADE7953
      libs:
        - location: https://github.com/mongoose-os-libs/onewire
        - location: https://github.com/mongoose-os-libs/dht
        - location: https://github.com/markirb/ade7953
        - location: https://github.com/mongoose-os-libs/mongoose
      build_vars:
        PARTITION_TABLE_OFFSET: 0x10000
        OTA_DATA_ADDR: 0x11000
        OTA_DATA_SIZE: 0x2000
        NVS_ADDR: 0x14000
        NVS_SIZE: 0xC000
        APP_OFFSET: 0x20000
        APP_SLOT_SIZE: 0x288000
        MGOS_ROOT_FS_TYPE: LFS
        MGOS_ROOT_FS_SIZE: 0xf8000
        ESP_IDF_EXTRA_PARTITION: "scratch,data,0x80,0x720000,0x80000,encrypted"
        ESP_IDF_EXTRA_PARTITION_2: "shelly,data,0x88,0x7F0000,64K,encrypted"
        ESP_IDF_SDKCONFIG_OPTS: >
          ${build_vars.ESP_IDF_SDKCONFIG_OPTS}
            CONFIG_FREERTOS_UNICORE=y
            CONFIG_ESPTOOLPY_FLASHMODE_DIO=y
            CONFIG_ESPTOOLPY_FLASHSIZE_8MB=y
            CONFIG_PARTITION_TABLE_OFFSET=0x10000
      cdefs:
        LED_GPIO: 2
        LED_ON: 0
        BTN_GPIO: 19
        BTN_DOWN: 0
        PRODUCT_HW_REV: "??"
        STOCK_FW_MODEL: S2PMG3
        MAX_NUM_HAP_SESSIONS: 16
        RELAY1_GPIO: 5
        RELAY2_GPIO: 3
        SWITCH1_GPIO: 18
        SWITCH2_GPIO: 10
        ADC_GPIO: 4
        SDA_GPIO: 6
        ADDON_OUT_GPIO: 9
        ADDON_IN_GPIO: 21
        ADDON_DIG_GPIO: -1
        I2C_RST_GPIO: 0
        PM_CH0: 0
        PM_CH1: 1
        MGOS_CONFIG_DEV_6: "shelly"
        MGOS_CONFIG_DEV_7: "shelly,4096"
      config_schema:
        - ["device.id",    "Shelly2PMG3-????????????"]
        - ["shelly.name",  "Shelly2PMG3-????????????"]
        - ["wifi.ap.ssid", "Shelly2PMG3-????????????"]
        - ["i2c.enable", true]
        - ["i2c.sda_gpio", 6]
        - ["i2c.scl_gpio", 7]
        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "Shelly SW1"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["sw2", "sw", {title: "SW2 settings"}]
        - ["sw2.name", "Shelly SW2"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Shelly SSW2"]
        - ["in2.sensor.name", "Shelly S2"]
        - ["in3", "in", {title: "Input 3 settings"}]
        - ["in3.ssw.name", "Shelly SSW3"]
        - ["in3.sensor.name", "Shelly S3"]
        - ["wc1", "wc", {title: "WC1 settings"}]
        - ["wc1.name", "Window 1"]
        - ["gdo1", "gdo", {title: "GDO1 settings"}]
        - ["gdo1.name", "Garage Door"]
        - ["ts1", "ts", {title: "TS1 settings"}]
        - ["ts1.name", "Shelly TS1"]
        - ["ts2", "ts", {title: "TS2 settings"}]
        - ["ts2.name", "Shelly TS2"]
        - ["ts3", "ts", {title: "TS3 settings"}]
        - ["ts4", "ts", {title: "TS4 settings"}]
        - ["ts4.name", "Shelly TS4"]
        - ["ts5", "ts", {title: "TS5 settings"}]
        - ["ts5.name", "Shelly TS5"]

        - ["factory", "o", {title: ""}]
        - ["factory.batch", "s", "", {title: ""}]
        - ["factory.model", "s", "", {title: ""}]
        - ["factory.version", "i", 0, {title: ""}]
        - ["factory.calib", "o", {title: "Factory calib settings"}]
        - ["factory.calib.done", "b", false, {title: ""}]
        - ["factory.calib.gains0", "gains", {title: ""}]

  - when: build_vars.MODEL == "ShellyMini1PMGen3"
    apply:
      name: Mini1PMG3
      libs:
        - location: https://github.com/mongoose-os-libs/mongoose
      sources:
        - src/BL0942
      build_vars:
        #PARTITION_TABLE_OFFSET: 0xF000 correct but problems with upgrade
        OTA_DATA_ADDR: 0x10000
        OTA_DATA_SIZE: 0x4000
        NVS_ADDR: 0x14000
        NVS_SIZE: 0xC000
        APP_OFFSET: 0x20000
        APP_SLOT_SIZE: 0x280000
        MGOS_ROOT_FS_TYPE: LFS
        MGOS_ROOT_FS_SIZE: 1048576
        ESP_IDF_EXTRA_PARTITION: "scratch,data,0x80,0x720000,0x80000,encrypted"
        ESP_IDF_EXTRA_PARTITION_2: "shelly,data,0x88,0x7F0000,64K,encrypted"
        ESP_IDF_SDKCONFIG_OPTS: >
          ${build_vars.ESP_IDF_SDKCONFIG_OPTS}
            CONFIG_FREERTOS_UNICORE=y
            CONFIG_ESPTOOLPY_FLASHMODE_DIO=y
            CONFIG_ESPTOOLPY_FLASHSIZE_8MB=y
        #CONFIG_PARTITION_TABLE_OFFSET=0xF000
      cdefs:
        LED_GPIO: 0
        LED_ON: 0
        BTN_GPIO: 1
        BTN_DOWN: 0
        PRODUCT_HW_REV: "0.1.0"
        STOCK_FW_MODEL: Mini1PMG3
        MAX_NUM_HAP_SESSIONS: 16
        MGOS_CONFIG_DEV_6: "shelly"
        MGOS_CONFIG_DEV_7: "shelly,4096"
      config_schema:
        - ["device.id",    "Shelly1PMMiniG3-????????????"]
        - ["shelly.name",  "Shelly1PMMiniG3-????????????"]
        - ["wifi.ap.ssid", "Shelly1PMMiniG3-????????????"]
        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "Shelly SW"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["gdo1", "gdo", {title: "GDO1 settings"}]
        - ["gdo1.name", "Garage Door"]
        - ["gdo1.open_sensor_mode", 2]

        - ["factory", "o", {title: ""}]
        - ["factory.batch", "s", "", {title: ""}]
        - ["factory.model", "s", "", {title: ""}]
        - ["factory.version", "i", 0, {title: ""}]
        - ["factory.calib", "o", {title: "Factory calib settings"}]
        - ["factory.calib.done", "b", false, {title: ""}]
        - ["factory.calib.scales0", "scales", {title: ""}]

  - when: build_vars.MODEL == "ShellyMini1Gen3"
    apply:
      name: Mini1G3
      libs:
        - location: https://github.com/mongoose-os-libs/mongoose
      build_vars:
        OTA_DATA_ADDR: 0x10000
        OTA_DATA_SIZE: 0x4000
        NVS_ADDR: 0x14000
        NVS_SIZE: 0xC000
        APP_OFFSET: 0x20000
        APP_SLOT_SIZE: 0x280000
        MGOS_ROOT_FS_TYPE: LFS
        MGOS_ROOT_FS_SIZE: 1048576
        ESP_IDF_EXTRA_PARTITION: "scratch,data,0x80,0x720000,0x80000,encrypted"
        ESP_IDF_EXTRA_PARTITION_2: "shelly,data,0x88,0x7F0000,64K,encrypted"
        ESP_IDF_SDKCONFIG_OPTS: >
          ${build_vars.ESP_IDF_SDKCONFIG_OPTS}
            CONFIG_FREERTOS_UNICORE=y
            CONFIG_ESPTOOLPY_FLASHMODE_DIO=y
            CONFIG_ESPTOOLPY_FLASHSIZE_8MB=y
      cdefs:
        LED_GPIO: 0
        LED_ON: 0
        BTN_GPIO: 1
        BTN_DOWN: 0
        PRODUCT_HW_REV: "0.1.0"
        STOCK_FW_MODEL: Mini1G3
        MAX_NUM_HAP_SESSIONS: 16
      config_schema:
        - ["device.id",    "ShellyMini1G3-????????????"]
        - ["shelly.name",  "ShellyMini1G3-????????????"]
        - ["wifi.ap.ssid", "ShellyMini1G3-????????????"]
        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "Shelly SW"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["gdo1", "gdo", {title: "GDO1 settings"}]
        - ["gdo1.name", "Garage Door"]
        - ["gdo1.open_sensor_mode", 2]

  - when: build_vars.MODEL == "ShellyPlus1Mini"
    apply:
      name: Plus1Mini
      sources:
        - src/ShellyMini1Gen3
      libs:
        - location: https://github.com/mongoose-os-libs/mongoose
      build_vars:
        MGOS_ROOT_FS_TYPE: LFS
        MGOS_ROOT_FS_SIZE: 0x60000
        APP_SLOT_SIZE: 0x190000
        ESP_IDF_EXTRA_PARTITION: "aux,0x55,0x00,0x3f0000,48K"
        ESP_IDF_EXTRA_PARTITION_2: "shelly,data,0x88,0x3fc000,16K,encrypted"
        ESP_IDF_SDKCONFIG_OPTS: >
          ${build_vars.ESP_IDF_SDKCONFIG_OPTS}
            CONFIG_FREERTOS_UNICORE=y
            CONFIG_ESPTOOLPY_FLASHMODE_DIO=y
            CONFIG_PARTITION_TABLE_CUSTOM_FILENAME=\"../esp32xx/partitions_mgos.csv\"
            CONFIG_PARTITION_TABLE_FILENAME=\"../esp32xx/partitions_mgos.csv\"
      cdefs:
        LED_GPIO: 0
        LED_ON: 0
        BTN_GPIO: 1
        BTN_DOWN: 0
        PRODUCT_HW_REV: "0.1.6"
        STOCK_FW_MODEL: Plus1Mini
        MAX_NUM_HAP_SESSIONS: 16
      config_schema:
        - ["device.id",    "ShellyPlus1Mini-????????????"]
        - ["shelly.name",  "ShellyPlus1Mini-????????????"]
        - ["wifi.ap.ssid", "ShellyPlus1Mini-????????????"]
        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "Shelly SW"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Shelly SSW2"]
        - ["in2.sensor.name", "Shelly S2"]
        - ["gdo1", "gdo", {title: "GDO1 settings"}]
        - ["gdo1.name", "Garage Door"]
        - ["gdo1.open_sensor_mode", 2]

  - when: build_vars.MODEL == "ShellyPlus1"
    apply:
      name: Plus1
      sources:
        - src/DS18XXX
        - src/DHT
      libs:
        - location: https://github.com/mongoose-os-libs/onewire
        - location: https://github.com/mongoose-os-libs/dht
        - location: https://github.com/mongoose-os-libs/mongoose
      build_vars:
        ESP_IDF_EXTRA_PARTITION: "aux,0x55,0x00,0x3f0000,48K"
        ESP_IDF_EXTRA_PARTITION_2: "shelly,data,0x88,0x3fc000,16K,encrypted"
        ESP_IDF_SDKCONFIG_OPTS: >
          ${build_vars.ESP_IDF_SDKCONFIG_OPTS}
            CONFIG_FREERTOS_UNICORE=y
            CONFIG_ESPTOOLPY_FLASHMODE_DIO=y
      cdefs:
        LED_GPIO: 0
        LED_ON: 0
        BTN_GPIO: 25
        BTN_DOWN: 0
        PRODUCT_HW_REV: "0.1.6"
        STOCK_FW_MODEL: Plus1
        MAX_NUM_HAP_SESSIONS: 16
        RELAY1_GPIO: 26
        SWITCH1_GPIO: 4
        ADC_GPIO: 32
        ADDON_OUT_GPIO: 0
        ADDON_IN_GPIO: 1
        ADDON_DIG_GPIO: 19
      config_schema:
        - ["device.id",    "shellyplus1-????????????"]
        - ["shelly.name",  "ShellyPlus1-????????????"]
        - ["wifi.ap.ssid", "ShellyPlus1-????????????"]
        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "Shelly SW"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Shelly SSW2"]
        - ["in2.sensor.name", "Shelly S2"]
        - ["gdo1", "gdo", {title: "GDO1 settings"}]
        - ["gdo1.name", "Garage Door"]
        - ["gdo1.open_sensor_mode", 2]
        # Only for backward compatibility (config <= v3).
        - ["ssw1", "ssw", {title: "SSW1 settings"}]
        - ["ssw1.name", "Input"]
        - ["ts1", "ts", {title: "TS1 settings"}]
        - ["ts1.name", "Shelly TS1"]
        - ["ts2", "ts", {title: "TS2 settings"}]
        - ["ts2.name", "Shelly TS2"]
        - ["ts3", "ts", {title: "TS3 settings"}]
        - ["ts3.name", "Shelly TS3"]
        - ["ts4", "ts", {title: "TS4 settings"}]
        - ["ts4.name", "Shelly TS4"]
        - ["ts5", "ts", {title: "TS5 settings"}]
        - ["ts5.name", "Shelly TS5"]

  - when: build_vars.MODEL == "ShellyPlus1PM"
    apply:
      name: Plus1PM
      sources:
        - src/DS18XXX
        - src/DHT
        - src/BL0937
      libs:
        - location: https://github.com/mongoose-os-libs/onewire
        - location: https://github.com/mongoose-os-libs/dht
        - location: https://github.com/mongoose-os-libs/mongoose
      build_vars:
        ESP_IDF_EXTRA_PARTITION: "aux,0x55,0x00,0x3f0000,48K"
        ESP_IDF_EXTRA_PARTITION_2: "shelly,data,0x88,0x3fc000,16K,encrypted"
        ESP_IDF_SDKCONFIG_OPTS: >
          ${build_vars.ESP_IDF_SDKCONFIG_OPTS}
            CONFIG_FREERTOS_UNICORE=y
            CONFIG_ESPTOOLPY_FLASHMODE_DIO=y
      cdefs:
        LED_GPIO: 0
        LED_ON: 0
        BTN_GPIO: 25
        BTN_DOWN: 0
        PRODUCT_HW_REV: "0.1.6"
        STOCK_FW_MODEL: Plus1PM
        MAX_NUM_HAP_SESSIONS: 16
        RELAY1_GPIO: 26
        SWITCH1_GPIO: 4
        ADC_GPIO: 32
        ADDON_OUT_GPIO: 0
        ADDON_IN_GPIO: 1
        ADDON_DIG_GPIO: 19
      config_schema:
        - ["device.id",    "ShellyPlus1PM-????????????"]
        - ["shelly.name",  "ShellyPlus1PM-????????????"]
        - ["wifi.ap.ssid", "ShellyPlus1PM-????????????"]
        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "Shelly SW"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Shelly SSW2"]
        - ["in2.sensor.name", "Shelly S2"]
        - ["gdo1", "gdo", {title: "GDO1 settings"}]
        - ["gdo1.name", "Garage Door"]
        - ["gdo1.open_sensor_mode", -1]
        # Calibration values from stock
        - ["bl0937_0", "o", {title: "BL0937 calibration"}]
        - ["bl0937_0.apower_scale", "f", 2.028531, {title: "BL0937 apower scale"}]
        - ["bl0937_0.voltage_scale", "f", 0.15510, {title: "BL0937 voltage scale"}]
        - ["bl0937_0.current_scale", "f", 0.01287, {title: "BL0937 current scale"}]

        # Only for backward compatibility (config <= v3).
        - ["ssw1", "ssw", {title: "SSW1 settings"}]
        - ["ssw1.name", "Input"]
        - ["ts1", "ts", {title: "TS1 settings"}]
        - ["ts1.name", "Shelly TS1"]
        - ["ts2", "ts", {title: "TS2 settings"}]
        - ["ts2.name", "Shelly TS2"]
        - ["ts3", "ts", {title: "TS3 settings"}]
        - ["ts3.name", "Shelly TS3"]
        - ["ts4", "ts", {title: "TS4 settings"}]
        - ["ts4.name", "Shelly TS4"]
        - ["ts5", "ts", {title: "TS5 settings"}]
        - ["ts5.name", "Shelly TS5"]

  - when: build_vars.MODEL == "ShellyPlus2PM"
    apply:
      name: Plus2PM
      sources:
        - src/DS18XXX
        - src/DHT
        - src/ADE7953
      includes:
        - src/ADE7953
      libs:
        - location: https://github.com/mongoose-os-libs/onewire
        - location: https://github.com/mongoose-os-libs/dht
        - location: https://github.com/mongoose-os-libs/ade7953
      build_vars:
        ESP_IDF_EXTRA_PARTITION: "aux,0x55,0x00,0x3f0000,48K"
        ESP_IDF_EXTRA_PARTITION_2: "shelly,data,0x88,0x3fc000,16K,encrypted"
        ESP_IDF_SDKCONFIG_OPTS: >
          ${build_vars.ESP_IDF_SDKCONFIG_OPTS}
            CONFIG_FREERTOS_UNICORE=y
            CONFIG_ESPTOOLPY_FLASHMODE_DIO=y
      cdefs:
        LED_GPIO: 0
        LED_ON: 0
        BTN_DOWN: 0
        PRODUCT_HW_REV: "0.1.9"
        STOCK_FW_MODEL: Plus2PM
        MAX_NUM_HAP_SESSIONS: 16
        SHELLY_HAVE_PM: 1
        MGOS_CONFIG_DEV_6: "shelly"
        MGOS_CONFIG_DEV_7: "shelly,4096"
        RELAY1_GPIO: 13
        RELAY2_GPIO: 12
        SWITCH1_GPIO: 2
        SWITCH2_GPIO: 18
        ADC_GPIO: 37
        SDA_GPIO: 33
        ADDON_OUT_GPIO: 0
        ADDON_IN_GPIO: 1
        ADDON_DIG_GPIO: 19
        I2C_RST_GPIO: -1
        PM_CH0: 1
        PM_CH1: 0
      config_schema:
        - ["device.id",    "ShellyPlus2PM-????????????"]
        - ["shelly.name",  "ShellyPlus2PM-????????????"]
        - ["wifi.ap.ssid", "ShellyPlus2PM-????????????"]
        - ["i2c.enable", true]
        - ["i2c.sda_gpio", 33]
        - ["i2c.scl_gpio", 25]
        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "Shelly SW1"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["sw2", "sw", {title: "SW2 settings"}]
        - ["sw2.name", "Shelly SW2"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Shelly SSW2"]
        - ["in2.sensor.name", "Shelly S2"]
        - ["in3", "in", {title: "Input 3 settings"}]
        - ["in3.ssw.name", "Shelly SSW3"]
        - ["in3.sensor.name", "Shelly S3"]
        - ["wc1", "wc", {title: "WC1 settings"}]
        - ["wc1.name", "Window 1"]
        - ["gdo1", "gdo", {title: "GDO1 settings"}]
        - ["gdo1.name", "Garage Door"]
        - ["ts1", "ts", {title: "TS1 settings"}]
        - ["ts1.name", "Shelly TS1"]
        - ["ts2", "ts", {title: "TS2 settings"}]
        - ["ts2.name", "Shelly TS2"]
        - ["ts3", "ts", {title: "TS3 settings"}]
        - ["ts4", "ts", {title: "TS4 settings"}]
        - ["ts4.name", "Shelly TS4"]
        - ["ts5", "ts", {title: "TS5 settings"}]
        - ["ts5.name", "Shelly TS5"]
        # Only for backward compatibility (config <= v3).
        - ["ssw1", "ssw", {title: "SSW1 settings"}]
        - ["ssw1.name", "Input 1"]
        - ["ssw2", "ssw", {title: "SSW2 settings"}]
        - ["ssw2.name", "Input 2"]

        #factory config saved at 0x1000 in shelly partition
        - ["factory", "o", {title: ""}]
        - ["factory.batch", "s", "", {title: ""}]
        - ["factory.model", "s", "", {title: ""}]
        - ["factory.version", "i", 0, {title: ""}]
        - ["factory.calib", "o", {title: "Factory calib settings"}]
        - ["factory.calib.done", "b", false, {title: ""}]
        - ["factory.calib.gains0", "gains", {title: ""}]

  - when: build_vars.MODEL == "ShellyPlusI4"
    apply:
      name: PlusI4
      sources:
        - src/DS18XXX
        - src/DHT
      libs:
        - location: https://github.com/mongoose-os-libs/onewire
        - location: https://github.com/mongoose-os-libs/dht
      build_vars:
        ESP_IDF_EXTRA_PARTITION: "aux,0x55,0x00,0x3f0000,48K"
        ESP_IDF_EXTRA_PARTITION_2: "shelly,data,0x88,0x3fc000,16K,encrypted"
        ESP_IDF_SDKCONFIG_OPTS: >
          ${build_vars.ESP_IDF_SDKCONFIG_OPTS}
            CONFIG_FREERTOS_UNICORE=y
            CONFIG_ESPTOOLPY_FLASHMODE_DIO=y
      cdefs:
        LED_GPIO: 0
        LED_ON: 0
        BTN_GPIO: 25
        BTN_DOWN: 0
        PRODUCT_HW_REV: "0.1.6"
        STOCK_FW_MODEL: PlusI4
        MAX_NUM_HAP_SESSIONS: 16
        SWITCH1_GPIO: 12
        SWITCH2_GPIO: 14
        SWITCH3_GPIO: 27
        SWITCH4_GPIO: 26
        ADC_GPIO: 32
        ADDON_OUT_GPIO: 0
        ADDON_IN_GPIO: 1
        ADDON_DIG_GPIO: 19
      config_schema:
        - ["device.id",    "ShellyPlusI4-????????????"]
        - ["shelly.name",  "ShellyPlusI4-????????????"]
        - ["wifi.ap.ssid", "ShellyPlusI4-????????????"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Shelly SSW2"]
        - ["in2.sensor.name", "Shelly S2"]
        - ["in3", "in", {title: "Input 3 settings"}]
        - ["in3.ssw.name", "Shelly SSW3"]
        - ["in3.sensor.name", "Shelly S3"]
        - ["in4", "in", {title: "Input 4 settings"}]
        - ["in4.ssw.name", "Shelly SSW4"]
        - ["in4.sensor.name", "Shelly S4"]
        - ["ts1", "ts", {title: "TS1 settings"}]
        - ["ts1.name", "Shelly TS1"]
        - ["ts2", "ts", {title: "TS2 settings"}]
        - ["ts2.name", "Shelly TS2"]
        - ["ts3", "ts", {title: "TS3 settings"}]
        - ["ts3.name", "Shelly TS3"]
        - ["ts4", "ts", {title: "TS4 settings"}]
        - ["ts4.name", "Shelly TS4"]
        - ["ts5", "ts", {title: "TS5 settings"}]
        - ["ts5.name", "Shelly TS5"]

  - when: build_vars.MODEL == "ShellyRGBW2"
    apply:
      name: rgbw2-color # To allow OTA from stock fw.
      libs:
        - location: https://github.com/mongoose-os-libs/mongoose
          variant: esp8266-nossl
      build_vars:
        FLASH_SIZE: 2097152
        FS_SIZE: 262144
        BOOT_CONFIG_ADDR: 0x7000  # To be compatible with stock firmware.
        MGOS_ROOT_FS_TYPE: SPIFFS
      cdefs:
        GPIO_R: 12
        GPIO_G: 15
        GPIO_B: 14
        GPIO_W: 4
        GPIO_I1: 5
        LED_GPIO: 2
        LED_ON: 0
        BTN_GPIO: 13
        BTN_DOWN: 0
        BTN_NOISY: 0
        RST_GPIO_INIT: 15 # reset GPIO 15 to prevent green flash on startup
        PRODUCT_HW_REV: "1.0"
        STOCK_FW_MODEL: SHRGBW2-color
        # We don't use SSL, HomeKit uses its own crypto. This saves ~120K.
        MG_ENABLE_SSL: 0
      config_schema:
        - ["shelly.mode", 3] # 0 - Default (4 Switches), 3 - RGB, 4 - RGBW, 5 - RGB+W, 6 - CCT, 7 - White
        - ["device.id", "shellyrgbw2-??????"]
        - ["shelly.name", "shellyrgbw2-??????"]
        - ["wifi.ap.ssid", "shellyrgbw2-??????"]
        - ["lb1", "lb", {title: "Light 1 settings"}]
        - ["lb2", "lb", {title: "Light 2 settings"}]
        - ["lb2.initial_state", 2] #input only available to lb1
        - ["lb3", "lb", {title: "Light 3 settings"}]
        - ["lb3.initial_state", 2] #input only available to lb1
        - ["lb4", "lb", {title: "Light 4 settings"}]
        - ["lb4.initial_state", 2] #input only available to lb1
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]

  - when: build_vars.MODEL == "ShellyUNI"
    apply:
      name: uni
      sources:
        - src/DS18XXX
        - src/DHT
      libs:
        - location: https://github.com/mongoose-os-libs/onewire
        - location: https://github.com/mongoose-os-libs/dht
        - location: https://github.com/mongoose-os-libs/mongoose
          variant: esp8266-nossl
      build_vars:
        FLASH_SIZE: 2097152
        FS_SIZE: 262144
        BOOT_CONFIG_ADDR: 0x1000
        MGOS_ROOT_FS_TYPE: SPIFFS
      cdefs:
        RELAY1_GPIO: 15
        RELAY2_GPIO: 4
        SWITCH1_GPIO: 12
        SWITCH2_GPIO: 13
        SENSOR_GPIO: 5
        LED_GPIO: 0
        LED_ON: 0
        BTN_GPIO: 2
        BTN_DOWN: 0
        PRODUCT_HW_REV: "1.0"
        STOCK_FW_MODEL: SHUNI-1
        MG_ENABLE_SSL: 0
      config_schema:
        - ["device.id", "shellyuni-????????????"]
        - ["shelly.name", "shellyuni-????????????"]
        - ["wifi.ap.ssid", "shellyuni-????????????"]
        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "Shelly SW1"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["sw2", "sw", {title: "SW2 settings"}]
        - ["sw2.name", "Shelly SW2"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Shelly SSW2"]
        - ["in2.sensor.name", "Shelly S2"]
        - ["gdo1", "gdo", {title: "GDO1 settings"}]
        - ["gdo1.name", "Garage Door"]

        - ["ts1", "ts", {title: "TS1 settings"}]
        - ["ts1.name", "Shelly TS1"]
        - ["ts2", "ts", {title: "TS2 settings"}]
        - ["ts2.name", "Shelly TS2"]
        - ["ts3", "ts", {title: "TS3 settings"}]
        - ["ts3.name", "Shelly TS3"]

  - when: build_vars.MODEL == "ShellyPlusUni"
    apply:
      name: PlusUni
      sources:
        - src/DS18XXX
        - src/DHT
        - src/ShellyUNI
      libs:
        - location: https://github.com/mongoose-os-libs/onewire
        - location: https://github.com/mongoose-os-libs/dht
        - location: https://github.com/mongoose-os-libs/mongoose
      build_vars:
        ESP_IDF_EXTRA_PARTITION: "aux,0x55,0x00,0x3f0000,48K"
        ESP_IDF_EXTRA_PARTITION_2: "shelly,data,0x88,0x3fc000,16K,encrypted"
        ESP_IDF_SDKCONFIG_OPTS: >
          ${build_vars.ESP_IDF_SDKCONFIG_OPTS}
            CONFIG_FREERTOS_UNICORE=y
            CONFIG_ESPTOOLPY_FLASHMODE_DIO=y
      cdefs:
        LED_GPIO: 18
        LED_ON: 0
        BTN_GPIO: -1
        BTN_DOWN: 0
        RELAY1_GPIO: 21
        RELAY2_GPIO: 19
        SWITCH1_GPIO: 37
        SWITCH2_GPIO: 38
        SENSOR_GPIO: 13
        PRODUCT_HW_REV: "0.1.4"
        STOCK_FW_MODEL: PlusUni
        MAX_NUM_HAP_SESSIONS: 16
      config_schema:
        - ["device.id",    "ShellyPlusUni-????????????"]
        - ["shelly.name",  "ShellyPlusUni-????????????"]
        - ["wifi.ap.ssid", "ShellyPlusUni-????????????"]

        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "Shelly SW1"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["sw2", "sw", {title: "SW2 settings"}]
        - ["sw2.name", "Shelly SW2"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "Shelly SSW2"]
        - ["in2.sensor.name", "Shelly S2"]
        - ["gdo1", "gdo", {title: "GDO1 settings"}]
        - ["gdo1.name", "Garage Door"]

        - ["ts1", "ts", {title: "TS1 settings"}]
        - ["ts1.name", "Shelly TS1"]
        - ["ts2", "ts", {title: "TS2 settings"}]
        - ["ts2.name", "Shelly TS2"]
        - ["ts3", "ts", {title: "TS3 settings"}]
        - ["ts3.name", "Shelly TS3"]
        - ["ts4", "ts", {title: "TS4 settings"}]
        - ["ts4.name", "Shelly TS4"]
        - ["ts5", "ts", {title: "TS5 settings"}]
        - ["ts5.name", "Shelly TS5"]


  - when: build_vars.MODEL == "ShellyVintage"
    apply:
      name: bulb6w # To allow OTA from stock fw.
      libs:
        - origin: https://github.com/mongoose-os-libs/mongoose
          variant: esp8266-nossl
      build_vars:
        FLASH_SIZE: 2097152
        FS_SIZE: 262144
        MGOS_ROOT_FS_TYPE: SPIFFS
      cdefs:
        PRODUCT_HW_REV: "1.0"
        STOCK_FW_MODEL: SHVIN-1
        # We don't use SSL, HomeKit uses its own crypto. This saves ~120K.
        MG_ENABLE_SSL: 0
      config_schema:
        - ["device.id", "ShellyVintage-??????"]
        - ["shelly.name", "ShellyVintage-??????"]
        - ["wifi.ap.ssid", "ShellyVintage-??????"]
        - ["lb1", "lb", {title: "Light bulb settings"}]
        - ["lb1.initial_state", 2] # last

  # Test device for BLE development.
  - when: build_vars.MODEL == "ShellyT32"
    apply:
      libs:
        # adding bt-common enables BLE support at compile time
        #- origin: https://github.com/mongoose-os-libs/bt-common
        #- origin: https://github.com/mongoose-os-libs/ethernet
      build_vars:
        APP_SLOT_SIZE: 0x1b0000
        MGOS_HAP_BLE: 1
        MGOS_ROOT_FS_TYPE: LFS
        ESP_IDF_EXTRA_PARTITION: "aux,data,0x88,0x3f0000,48K,encrypted"
        ESP_IDF_SDKCONFIG_OPTS: >
          ${build_vars.ESP_IDF_SDKCONFIG_OPTS}
            CONFIG_FREERTOS_UNICORE=y
            CONFIG_ESPTOOLPY_FLASHMODE_DIO=y
      cdefs:
        LED_GPIO: 13
        LED_ON: 1
        BTN_GPIO: 34
        BTN_DOWN: 0
        PRODUCT_HW_REV: "1.0"
        STOCK_FW_MODEL: XXX
        SHELLY_HAVE_PM: 0
        BTN_NOISY: 0
        MGOS_CONFIG_DEV_3: '"aux"'
      config_schema:
        # - ["bt.enable", true]
        - ["bt.adv_enable", false] # ADK controls advertisement.
        - ["bt.keep_enabled", true]
        - ["device.id", "ShellyT32-????"]
        - ["shelly.name", "ShellyT32-????"]
        - ["wifi.ap.ssid", "ShellyT32-??????"]
        - ["sw1", "sw", {"title": "SW settings"}]
        - ["sw1.name", "SWT32"]
        - ["sw1.in_mode", 0]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "SSWT32"]
        - ["in1.sensor.name", "ST32"]

  - when: build_vars.MODEL == "ShellyU"
    apply:
      sources:
        - src/mock/pwm
        - src/mock/wifi_config
      libs:
        - location: https://github.com/mongoose-os-libs/mongoose
          variant: ubuntu-nossl
      cdefs:
        PRODUCT_HW_REV: "1.0"
        STOCK_FW_MODEL: XXX
        MG_ENABLE_SSL: 0
        SHELLY_HAVE_PM: 1
        BTN_NOISY: 0
      config_schema:
        - ["device.id", "ShellyU-????"]
        - ["shelly.name", "ShellyU-????"]
        - ["file_logger.dir", "./"]
        - ["ts1", "ts", {title: "TS1 settings"}]
        - ["ts1.name", "Shelly TS"]
        - ["ts2", "ts", {title: "TS2 settings"}]
        - ["ts2.name", "Shelly TS"]
        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "ShellyU SW1"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "ShellyU SSW1"]
        - ["in1.sensor.name", "ShellyU S1"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "ShellyU SSW2"]
        - ["in2.sensor.name", "ShellyU S2"]

  - when: build_vars.MODEL == "ShellyUDuo"
    apply:
      sources:
        - src/ShellyDuo/shelly_init.cpp
        - src/mock/pwm
        - src/mock/wifi_config
      libs:
        - location: https://github.com/mongoose-os-libs/mongoose
          variant: ubuntu-nossl
      cdefs:
        PRODUCT_HW_REV: "1.0"
        STOCK_FW_MODEL: XXX
        MG_ENABLE_SSL: 0
        SHELLY_HAVE_PM: 0
        BTN_NOISY: 0
      config_schema:
        - ["device.id", "ShellyUBulbDuo-??????"]
        - ["shelly.name", "ShellyUBulbDuo-??????"]
        - ["wifi.ap.ssid", "ShellyUBulbDuo-??????"]
        - ["lb1", "lb", {title: "Light bulb settings"}]
        - ["lb1.initial_state", 2] # last

  - when: build_vars.MODEL == "ShellyU25"
    apply:
      sources:
        - src/Shelly25/shelly_init_components.cpp  # Same components as Shelly25
        - src/mock/pwm
        - src/mock/wifi_config
      libs:
        - location: https://github.com/mongoose-os-libs/mongoose
          variant: ubuntu-nossl
      cdefs:
        PRODUCT_HW_REV: "1.0"
        STOCK_FW_MODEL: XXX
        MG_ENABLE_SSL: 0
        SHELLY_HAVE_PM: 1
        BTN_NOISY: 0
      config_schema:
        - ["device.id", "ShellyU25-????"]
        - ["shelly.name", "ShellyU25-????"]
        - ["file_logger.dir", "./"]
        - ["sw1", "sw", {title: "SW1 settings"}]
        - ["sw1.name", "ShellyU25 SW1"]
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "ShellyU25 SSW1"]
        - ["in1.sensor.name", "Shelly S1"]
        - ["sw2", "sw", {title: "SW2 settings"}]
        - ["sw2.name", "ShellyU25 SW2"]
        - ["in2", "in", {title: "Input 2 settings"}]
        - ["in2.ssw.name", "ShellyU25 SSW2"]
        - ["in2.sensor.name", "ShellyU25 S2"]
        - ["wc1", "wc", {title: "WC1 settings"}]
        - ["wc1.name", "Window 1"]
        - ["gdo1", "gdo", {title: "GDO1 settings"}]
        - ["gdo1.name", "ShellyU25 GDO"]

  - when: build_vars.MODEL == "ShellyURGBW2"
    apply:
      sources:
        - src/ShellyRGBW2/shelly_init.cpp  # Same components as ShellyRGBW2
        - src/mock/pwm
        - src/mock/wifi_config
      libs:
        - location: https://github.com/mongoose-os-libs/mongoose
          variant: ubuntu-nossl
      cdefs:
        PRODUCT_HW_REV: "1.0"
        STOCK_FW_MODEL: XXX
        MG_ENABLE_SSL: 0
        SHELLY_HAVE_PM: 0
        BTN_NOISY: 0
      config_schema:
        - ["device.id", "ShellyRGBW2-????"]
        - ["shelly.name", "ShellyRGBW2-????"]
        - ["file_logger.dir", "./"]
        - ["shelly.mode", 3]
        - ["lb1", "lb", {title: "Light 1 settings"}]
        - ["lb2", "lb", {title: "Light 2 settings"}]
        - ["lb2.initial_state", 2] #input only available to lb1
        - ["lb3", "lb", {title: "Light 3 settings"}]
        - ["lb3.initial_state", 2] #input only available to lb1
        - ["lb4", "lb", {title: "Light 4 settings"}]
        - ["lb4.initial_state", 2] #input only available to lb1
        - ["in1", "in", {title: "Input 1 settings"}]
        - ["in1.ssw.name", "Shelly SSW1"]
        - ["in1.sensor.name", "Shelly S1"]

manifest_version: 2020-01-29
