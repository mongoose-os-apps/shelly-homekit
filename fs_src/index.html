<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
  <script src="axios.min.js.gz"></script>
<style>
html, body { height: 100vh; padding: 0; margin: 5; background-color: #f2f1f6;}

* { outline: none !important; }
body { color: #454955; font: 14px/1.5 '-apple-system', 'HelveticaNeue', Helvetica, Segoe UI; }
h1, h2, h3, h4, h5, h6, b, th, strong, .nav-link { color: #454955; }
input, button, div, pre, p { font: inherit; }
button {
  color: white; padding: 0.5em 1em; border-radius: 18px;
  border: none; cursor: pointer;
}
a { 
  text-decoration: none; 
  color: #0071e3;
}
  a:link, a:visited {
  color: #0071e3;
  text-decoration: none; 
}

input[type=password] {
  width: 160px;
  padding: 0.2em 0.7em; position: relative;
  border: 1px solid #cdcdcd; border-color: rgba(0, 0, 0, .15);
  background-color: #ffffff; font-size: 14px;
}
input[type=text] {
  width: 160px;
  padding: 0.2em 0.7em; position: relative;
  border: 1px solid #cdcdcd; border-color: rgba(0, 0, 0, .15);
  background-color: #ffffff; font-size: 14px;
}
h1 { margin: 0; padding-top: 0.5em; text-align: center; }
.header { padding: 0 1em; margin: 1em auto; max-width: 640px; background: #f2f1f6; border-radius: 15px; }
.footer { padding: 0 1em; margin: 1em auto; max-width: 640px; background: #f2f1f6; border-radius: 15px; font: 11px '-apple-system', 'HelveticaNeueLight', Helvetica Light, Segoe UI Light; color: #aaaaae;}
.container { padding: 0 1em; margin: 1em auto ; max-width: 640px; background: #fefefe; border-radius: 10px; }
.form-control { margin: 0.6em 0; }
.form-control input:not([type="checkbox"]), .form-control button { min-width: 10em; }
.form label { min-width: 9.0em; display: inline-block; }
.form { padding: 1em 0; }
.btn { background: #0071e3; }
.btn label { position: relative; }
.btndis { 
  background: #f2f1f6; 
  color: #25282A;
}
.badge {
  background-color: #ff0800;
  border: 2px solid #ff0800;
  border-radius: 12px;
  box-shadow: 1px 1px 1px #282828;
  color: #ffffff;
  font: bold 12px/9px Helvetica, Verdana, Tahoma;
  height: 12px;
  padding: 4px 3px 0 5px;
  text-align: center;
  min-width: 8px;
  display: inline;
  position: absolute;
}
.helpbadge {
  background-color: #fefefe;
  border: 1px solid #999999;
  border-radius: 12px;
  box-shadow: 1px 1px 0.5px #c1c1c1;
  color: #0071e3 !important; 
  font: bold 14px/10px HelveticaNeueLight, Helvetica, Verdana;
  height: 13px;
  padding: 6px 6px 1px 6px;
  text-align: center;
  min-width: 8px;
  position: relative; margin-top: 4px; margin-right: -10px;
  float: right;
}
.apl_thin {
  margin-left: 80px; 
  height: 75px; 
  padding-top: 0.25em; 
  padding-left: 10px; 
  color: #454955; 
  font: 36px '-apple-system', 'HelveticaNeueLight', Helvetica Light, Segoe UI Light;
}
.icon {
   width: 25px;
   height: 25px;
   vertical-align: top;
   padding-top: 0.28em; 
}
.logodiv {
  float:left; 
  width: 80px; 
  height: 80px; 
  padding-left: 10px;
}
.img { 
  display: block;
  margin-left: auto;
  margin-right: auto;
  width: 80px;
  height: 80px; 
 }
.spin {
  display: inline-block; width: 1em; height: 1em;
  margin-bottom: -0.2em; 
  border: 0.15em solid rgba(255,255,255,.5);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s linear infinite;
  -webkit-animation: spin 1s linear infinite;
  position: absolute; top: 0; left: 0;
}
@keyframes spin { to { transform: rotate(360deg); } }
@-webkit-keyframes spin { to { -webkit-transform: rotate(360deg); } }

.switch {
  position: relative;
  display: inline-block;
  width: 57px;
  height: 32px;
  min-width: 0.5em !important;
  vertical-align: middle;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 24px;
  width: 24px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: #34c759;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(24px);
  -ms-transform: translateX(24px);
  transform: translateX(24px);
}

/* Rounded sliders */
.slider.round {
  border-radius: 32px;
}

.slider.round:before {
  border-radius: 50%;
}
</style>
</head>
<body onLoad="onLoad()">

<div class="container">
  <a class="helpbadge" href="https://github.com/mongoose-os-apps/shelly-homekit/wiki/" target="_blank">?</a>
  <div class="logodiv"><img class="img" src="logo.png" alt=""></div>
  <div class="apl_thin">
    Shelly-<b>HomeKit</b>
    <div class="badge" id="notify_update" style="display: none">Update</div>
    <div class="badge" id="notify_overheat" style="display: none">Overheating</div>
    <div class="badge" id="notify_failsafe" style="display: none">Failsafe mode</div>
  </div>
  <h1 class="" id="device_name" style="visibility: hidden"></h1>
  <br>
  <button class="btn" id="refresh_btn">
    <label><span id="spinner"></span>Refresh</label>
  </button>
  <button class="btn" id="reboot_btn">Reboot</button>
  <button disabled class="btndis" id="uptime_label">
    Uptime: <span id="uptime"></span>
  </button>
 <br><br>
</div>
<div class="container" id="gs_container" style="display: none">
  <a class="helpbadge" href="https://github.com/mongoose-os-apps/shelly-homekit/wiki/General-Settings" target="_blank">?</a>
  <h1 class="">General Settings</h1>
  <div class="form">
    <div class="">
      <div class="form-control">
        <label>Name:</label>
        <input type="text" id="sys_name">
      </div>
      <div class="form-control" id="sys_mode_container" style="display: none">
        <label>Mode:</label>
        <select id="sys_mode">
          <option id="sys_mode_0" value="0">Switch</option>
          <option id="sys_mode_1" value="1">Roller Shutter</option>
          <option id="sys_mode_2" value="2">Garage Door Opener</option>
        </select>
      </div>
      <div class="form-control">
        <label></label>
        <button class="btn" id="sys_save_btn">
          <label><span id="sys_save_spinner"></span>Save</label>
        </button>
      </div>
    </div>
  </div>
</div>
<div id="components"></div>
<div class="container" id="homekit_container" style="display: none">
  <a class="helpbadge" href="https://github.com/mongoose-os-apps/shelly-homekit/wiki/HomeKit-settings" target="_blank">?</a>
  <h1 class="">HomeKit Settings</h1>
  <div class="form">
    <div class="">
      <div class="form-control">
        <label>Paired:</label>
        <span id="hap_paired"></span>
      </div>
      <div class="form-control">
        <label>Connections:</label>
        <span id="hap_conn_stats"></span>
      </div>
      <div class="form-control">
        <label>Setup code:</label>
        <input type="text" id="hap_setup_code" placeholder="111-22-333">
      </div>
      <div class="form-control">
        <label></label>
        <button class="btn" id="hap_save_btn">
          <label><span id="hap_save_spinner"></span>Save</label>
        </button>
        <button class="btn" id="hap_reset_btn">
          <label><span id="hap_reset_spinner"></span>Reset</label>
        </button>
      </div>
    </div>
  </div>
</div>
<div class="container" id="wifi_container" style="display: none">
  <a class="helpbadge" href="https://github.com/mongoose-os-apps/shelly-homekit/wiki/WiFi-Settings" target="_blank">?</a>
  <h1 class="">WiFi Settings</h1>
  <div class="form">
    <div class="">
      <div class="form-control">
        <label>Enable:</label>
        <label class="switch">
          <input type="checkbox" id="wifi_en">
          <span class="slider round"></span>
        </label>
      </div>
      <div class="form-control">
        <label>WiFi network:</label>
        <input type="text" id="wifi_ssid">
      </div>
      <div class="form-control">
        <label>WiFi password:</label>
        <input type="password" id="wifi_pass">
      </div>
      <div class="form-control">
        <label>Status:</label>
        <span id="wifi_status"></span>
      </div>
      <div class="form-control">
        <label></label>
        <button class="btn" id="wifi_save_btn">
          <label><span id="wifi_spinner"></span>Save</label>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="container" id="sys_container">
  <a class="helpbadge" href="https://github.com/mongoose-os-apps/shelly-homekit/wiki/System-Settings" target="_blank">?</a>
  <h1 class="">System</h1>
  <div class="form">
    <div class="">
      <div class="form-control">
        <label>Device:</label>
        Model: <span id="model"></span>,
        ID: <span id="device_id"></span>
      </div>
      <div class="form-control">
        <label>Version:</label>
        <span id="app_version"></span>
      </div>
      <div class="form-control" id="update_container" style="display: none">
        <label>Update: </label>
        <button class="btn" id="update_btn">
          <label>
            <span id="update_btn_spinner"></span>
            <span id="update_btn_text">Check</span>
          </label>
        </button>
        <span id="update_status"></span>
      </div>
      <div class="form-control" id="revert_to_stock_container" style="display: none">
        <label>Revert to stock:</label>
        <button class="btn" id="revert_btn">
          <label><span id="revert_btn_spinner"></span>Revert</label>
        </button>
        <span id="revert_status"></span>
        <div id="revert_msg" style="margin-left: 9em; display: none">Please consider reporting missing features
          <a href="https://github.com/mongoose-os-apps/shelly-homekit/issues">on GitHub</a>.</div>
      </div>
      <div class="form-control">
        <label>Update from file:</label>
        <form id="fw_upload_form" method="POST" action="/update" enctype="multipart/form-data" style="display: inline">
          <input type="file" id="fw_select_file" name="file" accept=".zip" />
          <button class="btn" id="fw_upload_btn">
            <label><span id="fw_spinner"></span>Upload</label>
          </button>
        </form>
      </div>
      <div class="form-control" id="debug_log_container" style="display: none">
        <label>Debug Log:</label>
        <label class="switch">
          <input type="checkbox" id="debug_en">
          <span class="slider round"></span>
        </label>
        <span id="debug_link"><a href="/debug/log?follow=1" style="margin-left: 1em">Log</a></span>
      </div>
      <div class="form-control" id="sys_temp_container" style="display: none">
        <label>Temperature:</label>
        <span id="sys_temp"></span>&deg;C
      </div>
    </div>
  </div>
</div>

<div class="container">
  <div class="form" style="text-align: center">
    &copy; Copyright 2020 <a href="https://github.com/mongoose-os-apps/shelly-homekit/blob/master/AUTHORS.md">Shelly-HomeKit contributors</a>.
    <br>Use <a href="https://github.com/mongoose-os-apps/shelly-homekit/issues">GitHub</a> to report bugs and request features.
    <br>
    <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
      <input type="hidden" name="cmd" value="_s-xclick" />
      <input type="hidden" name="hosted_button_id" value="6KPSKWJDHVLB4" />
      <input type="image" id="donate_form_submit" src="" border="0" name="submit" title="Donate via PayPal" alt="Donate via PayPal" style="display: none" />
    </form>
  </div>
</div>

<!-- Component section templates -->

<div class="container" id="sw_template" style="display: none">
  <a class="helpbadge" href="https://github.com/mongoose-os-apps/shelly-homekit/wiki/Switch-Settings" target="_blank">?</a>
  <h1 id="head">Switch</h1>
  <div class="form">
    <div class="">
      <div class="form-control">
        <label>Status:</label>
        <span id="state">off</span>
        <span id="power_stats"></span>
      </div>
      <div class="form-control">
        <label></label>
        <button class="btn" id="toggle_btn">
          <label><span id="set_spinner"></span><span id="btn_label">Turn On</span></label>
        </button>
      </div>
    </div>
    <div class="">
      <div class="form-control">
        <label>Name:</label>
        <input type="text" id="name">
      </div>
      <div class="form-control">
        <label>HAP Type:</label>
        <select id="svc_type">
          <option id="svc_type_-1" value="-1">Disabled</option>
          <option id="svc_type_0" value="0">Switch</option>
          <option id="svc_type_1" value="1">Outlet</option>
          <option id="svc_type_2" value="2">Lock</option>
        </select>
      </div>
      <div class="form-control" id="in_mode_container">
        <label>Input Mode:</label>
        <select id="in_mode">
          <option id="in_mode_0" value="0">Momentary</option>
          <option id="in_mode_1" value="1">Toggle</option>
          <option id="in_mode_2" value="2">Edge</option>
          <option id="in_mode_3" value="3">Detached</option>
          <option id="in_mode_4" value="4">Activation</option>
        </select>
      </div>
      <div class="form-control" id="in_inverted_container" style="display: none">
        <label for="in_inverted">Inverted Input:</label>
          <label class="switch">
            <input type="checkbox" id="in_inverted">
          <span class="slider round"></span>
        </label>
      </div>
      <div class="form-control">
        <label for="initial">Initial state:</label>
        <select id="initial">
          <option id="initial_0" value="0">Off</option>
          <option id="initial_1" value="1">On</option>
          <option id="initial_2" value="2">Last</option>
          <option id="initial_3" value="3">Input</option>
        </select>
      </div>
      <div class="form-control">
        <label for="auto_off">Auto off:</label>
          <label class="switch">
            <input type="checkbox" id="auto_off">
          <span class="slider round"></span>
        </label>
      </div>
      <div>
        <label for="auto_off_delay">Auto off delay:</label>
        <input type="text" id="auto_off_delay" placeholder="D:HH:MM:SS.sss" required
               pattern="[0-9]+:(0[0-9]|1[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]\.[0-9]{3}">
      </div>
      <div class="form-control">
        <label></label>
        <button class="btn" id="save_btn">
          <label><span id="save_spinner"></span>Save</label>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="container" id="ssw_template" style="display: none">
  <a class="helpbadge" href="https://github.com/mongoose-os-apps/shelly-homekit/wiki/Switch-Settings#detached-input" target="_blank">?</a>
  <h1 id="head">Input</h1>
  <div class="form">
    <div class="">
      <div class="form-control">
        <label>Name:</label>
        <input type="text" id="name">
      </div>
      <div class="form-control">
        <label>Input Mode:</label>
        <select id="in_mode">
          <option id="in_mode_0" value="0">Momentary</option>
          <option id="in_mode_1" value="1">Toggle, on = off = single press</option>
          <option id="in_mode_2" value="2">Toggle, on = single, off = double</option>
        </select>
      </div>
      <div class="form-control">
        <label>Last Event:</label>
        <span id="last_event"></span>
      </div>
      <div class="form-control">
        <label></label>
        <button class="btn" id="save_btn">
          <label><span id="save_spinner"></span>Save</label>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="container" id="wc_template" style="display: none">
  <a class="helpbadge" href="https://github.com/mongoose-os-apps/shelly-homekit/wiki/Roller-Shutter-Settings" target="_blank">?</a>
  <h1 id="head">Window</h1>
  <div class="form">
    <div class="">
      <div class="form-control">
        <label>Name:</label>
        <input type="text" id="name">
      </div>
      <div class="form-control">
        <label>Status:</label>
        <span id="state"></span> pos
        <span id="pos"></span>
      </div>
      <div class="form-control" id="pos_ctl">
        <label></label>
        <button class="btn" id="open_btn">
          <label><span id="open_spinner"></span>Open</label>
        </button>
        <button class="btn" id="close_btn">
          <label><span id="close_spinner"></span>Close</label>
        </button>
      </div>
      <div class="form-control">
        <label>Calibration:</label>
        <span id="cal"></span>
      </div>
      <div class="form-control">
        <label>Input Mode:</label>
        <select id="in_mode">
          <option id="in_mode_0" value="0">Separate - momentary</option>
          <option id="in_mode_1" value="1">Separate - toggle</option>
          <option id="in_mode_2" value="2">Single</option>
          <option id="in_mode_3" value="3">Detached</option>
        </select>
      </div>
      <div class="form-control">
        <label>Swap Inputs:</label>
          <label class="switch">
            <input type="checkbox" id="swap_inputs">
          <span class="slider round"></span>
        </label>
      </div>
      <div class="form-control">
        <label>Swap Outputs:</label>
          <label class="switch">
            <input type="checkbox" id="swap_outputs">
          <span class="slider round"></span>
        </label>
      </div>
      <div class="form-control" id="btns">
        <label></label>
        <button class="btn" id="save_btn">
          <label><span id="save_spinner"></span>Save</label>
        </button>
        <button class="btn" id="cal_btn">
          <label><span id="cal_spinner"></span>Calibrate</label>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="container" id="gdo_template" style="display: none">
  <a class="helpbadge" href="https://github.com/mongoose-os-apps/shelly-homekit/wiki/Garage-Door-Opener-Settings" target="_blank">?</a>
  <h1 id="head">Garage Door</h1>
  <div class="form">
    <div class="">
      <div class="form-control">
        <label>Name:</label>
        <input type="text" id="name">
      </div>
      <div class="form-control">
        <label>Status:</label>
        <span id="state"></span>
      </div>
      <div class="form-control">
        <label>Close Sensor:</label>
        <select id="close_sensor_mode">
          <option id="close_sensor_mode_0" value="0">Normally Closed</option>
          <option id="close_sensor_mode_1" value="1">Normally Open</option>
        </select>
      </div>
      <div class="form-control" id="open_sensor_mode_container">
        <label>Open Sensor:</label>
        <select id="open_sensor_mode">
          <option id="open_sensor_mode_0" value="0">Normally Closed</option>
          <option id="open_sensor_mode_1" value="1">Normally Open</option>
          <option id="open_sensor_mode_2" value="2">Disabled</option>
        </select>
      </div>
      <div class="form-control" id="out_mode_container">
        <label>Output Mode:</label>
        <select id="out_mode">
          <option id="out_mode_0" value="0">Single</option>
          <option id="out_mode_1" value="1">Dual</option>
        </select>
      </div>
      <div class="form-control">
        <label>Movement Time:</label>
        <input type="text" id="move_time" style="width: 2em; min-width: 2em;"> seconds
      </div>
      <div class="form-control">
        <label>Pulse Time:</label>
        <input type="text" id="pulse_time_ms" style="width: 2em; min-width: 2em;"> ms
      </div>
      <div class="form-control" id="btns">
        <label></label>
        <button class="btn" id="save_btn">
          <label><span id="save_spinner"></span>Save</label>
        </button>
        <button class="btn" id="toggle_btn">
          <label><span id="toggle_spinner"></span>Toggle</label>
        </button>
      </div>
    </div>
  </div>
</div>

<script>

var lastInfo = null;
var host = "";

var autoRefresh = false;

var wifiEn = el("wifi_en");
var wifiSSID = el("wifi_ssid");
var wifiPass = el("wifi_pass");
var wifiSpinner = el("wifi_spinner");

var hapSetupCode = el("hap_setup_code");
var hapSaveSpinner = el("hap_save_spinner");
var hapResetSpinner = el("hap_reset_spinner");

var sw1 = el("sw1_container");
var sw2 = el("sw2_container");

function el(container, id) {
  if (id === undefined) {
    id = container;
    container = document;
  }
  return container.querySelector("#" + id);
}

function checkName(name) {
  var ok = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-";
  if (name.length == 0 || name.length > 63) return false;
  for (var i in name) {
    if (ok.indexOf(name[i]) < 0) return false;
  }
  return true;
}

el("sys_save_btn").onclick = function() {
  if (!checkName(el("sys_name").value)) {
    alert("Name must be between 1 and 63 characters "+
          "and consist of letters, numbers or dashes ('-')");
    return;
  }
  var data = {
    config: {
      name: el("sys_name").value,
      sys_mode: parseInt(el("sys_mode").value),
    },
  };
  console.log("sysSetCfg:", data);
  el("sys_save_spinner").className = "spin";
  axios.post(host + "/rpc/Shelly.SetConfig", data).then(function(res) {
    el("sys_save_spinner").className = "";
    setTimeout(getInfo, 1100);
  }).catch(function(err) {
    el("sys_save_spinner").className = "";
    if (err.response) {
      err = err.response.data.message;
    }
    alert(err);
  });
};

el("hap_save_btn").onclick = function() {
  var code = hapSetupCode.value;
  if (!code.match(/^\d\d\d-\d\d-\d\d\d$/)) {
    if (code.match(/^\d\d\d\d\d\d\d\d$/)) {
      code = code.substr(0, 3) + "-" + code.substr(3, 2) + "-" + code.substr(5, 3);
    } else {
      alert("Invalid code '" + code + "', must be xxxyyzzz or xxx-yy-zzz.");
      return;
    }
  }
  hapSaveSpinner.className = "spin";
  axios.post(host + "/rpc/HAP.Setup", {"code": code}).then(function(res) {
  }).catch(function(err) {
    if (err.response) {
      err = err.response.data.message;
    }
    alert(err);
  }).then(function() {
    hapSaveSpinner.className = "";
    getInfo();
  });
};

el("hap_reset_btn").onclick = function() {
  hapResetSpinner.className = "spin";
  axios.post(host + "/rpc/HAP.Reset", {"reset_server": true, "reset_code": true}).then(function(res) {
  }).catch(function(err) {
    if (err.response) {
      err = err.response.data.message;
    }
    alert(err);
  }).then(function() {
    hapResetSpinner.className = "";
    getInfo();
  });
};

el("fw_upload_btn").onclick = function() {
  el("fw_spinner").className = "spin";
  el("fw_upload_form").submit();
  return true;
};

el("wifi_save_btn").onclick = function() {
  wifiSpinner.className = "spin";
  var data = {
    config: {
      wifi: {
        sta: { enable: wifiEn.checked, ssid: wifiSSID.value},
        ap: { enable: !wifiEn.checked },
      },
    },
    reboot: true,
  };
  if (wifiPass.value != "***") data.config.wifi.sta.pass = wifiPass.value;
  axios.post(host + "/rpc/Config.Set", data).then(function(res) {
    var dn = el("device_name").innerText;
    document.body.innerHTML =
      "<div class='container'><h1>Rebooting...</h1>" +
      "<p>Device is rebooting and connecting to <i>" + wifiSSID.value + "</i>." +
      "<p>Connect to the same network and visit " +
      "<a href='http://" + dn + ".local/'>http://" + dn + ".local/</a>." +
      "<p>If device cannot be contacted, see " +
      "<a href='https://github.com/mongoose-os-apps/shelly-homekit/wiki/Recovery'>here</a> for recovery options." +
      "</div>.";
  }).catch(function(err) {
    if (err.response) {
      err = err.response.data.message;
    }
    alert(err);
  }).then(function() {
    wifiSpinner.className = "";
  });
};

function setComponentConfig(c, cfg, spinner) {
  if (spinner) spinner.className = "spin";
  var data = {
    id: c.data.id,
    type: c.data.type,
    config: cfg,
  };
  console.log("SetConfig:", data);
  axios.post(host + "/rpc/Shelly.SetConfig", data)
    .then(function(res) {
      if (spinner) spinner.className = "";
      setTimeout(getInfo, 1100);
    }).catch(function(err) {
      if (spinner) spinner.className = "";
      if (err.response) {
        err = err.response.data.message;
      }
      alert(err);
    });
}

function swSetState(c, newState) {
  var spinner = el(c, "set_spinner");
  spinner.className = "spin";
  axios.post(host + "/rpc/Shelly.SetSwitch", {id: c.data.id, state: newState}).then(function(res) {
  }).catch(function(err) {
    if (err.response) {
      err = err.response.data.message;
    }
    alert(err);
  }).then(function() {
    spinner.className = "";
    getInfo();
  });
}

function autoOffDelayValid(value) {
  return (dateStringToSeconds(value) >= 0.010) &&
         (dateStringToSeconds(value) <= 2147483.647);
}

function dateStringToSeconds(dateString) {
  if (dateString == "") return 0;
  var dateStringParts = dateString.split(':');
  var secondsPart = dateStringParts[3].split('.')[0];
  var fractionPart = dateStringParts[3].split('.')[1];
  var seconds = parseInt(dateStringParts[0]) * 24 * 3600 +
                parseInt(dateStringParts[1]) * 3600 +
                parseInt(dateStringParts[2]) * 60 +
                parseInt(secondsPart) +
                parseFloat(fractionPart / 1000);
  return seconds;
}

function secondsToDateString(seconds) {
  if (seconds == 0) return "";
  var date = new Date(1970, 0, 1);
  date.setMilliseconds(seconds * 1000);
  var dateString = Math.floor(seconds/3600/24) + ":" +
                   nDigitString(date.getHours(), 2) + ":" +
                   nDigitString(date.getMinutes(), 2) + ":" +
                   nDigitString(date.getSeconds(), 2) + "." +
                   nDigitString(date.getMilliseconds(), 3);
  return dateString;
}

function nDigitString(num, digits) {
  return num.toString().padStart(digits, "0");
}

function swSetConfig(c) {
  var name = el(c, "name").value;
  var svcType = el(c, "svc_type").value;
  var initialState = el(c, "initial").value;
  var autoOff = el(c, "auto_off").checked;
  var autoOffDelay = el(c, "auto_off_delay").value;
  var spinner = el(c, "save_spinner");

  if (name == "") {
    alert("Name must not be empty");
    return;
  }

  if (autoOff && autoOffDelay && !autoOffDelayValid(autoOffDelay)) {
    alert("Auto off delay must follow 24 hour format D:HH:MM:SS.sss with a value between 10ms and 24 days.");
    return;
  }

  var cfg = {
    name: name,
    svc_type: parseInt(el(c, "svc_type").value),
    initial_state: parseInt(el(c, "initial").value),
    auto_off: autoOff,
    in_inverted: el(c, "in_inverted").checked,
  };
  if (autoOff) {
    cfg.auto_off_delay = dateStringToSeconds(autoOffDelay);
  }
  if (c.data.in_mode >= 0) {
    cfg.in_mode = parseInt(el(c, "in_mode").value);
  }
  setComponentConfig(c, cfg, spinner);
}

function sswSetConfig(c) {
  var name = el(c, "name").value;
  var spinner = el(c, "save_spinner");

  if (name == "") {
    alert("Name must not be empty");
    return;
  }
  var cfg = {
    name: name,
    in_mode: parseInt(el(c, "in_mode").value),
  };
  setComponentConfig(c, cfg, spinner);
}

function wcSetConfig(c, cfg, spinner) {
  if (!cfg) {
    var name = el(c, "name").value;
    if (name == "") {
      alert("Name must not be empty");
      return;
    }
    cfg = {
      name: name,
      in_mode: parseInt(el(c, "in_mode").value),
      swap_inputs: el(c, "swap_inputs").checked,
      swap_outputs: el(c, "swap_outputs").checked,
    };
  }
  setComponentConfig(c, cfg, spinner);
}

function gdoSetConfig(c, cfg, spinner) {
  if (!cfg) {
    var name = el(c, "name").value;
    if (name == "") {
      alert("Name must not be empty");
      return;
    }
    var moveTime = parseInt(el(c, "move_time").value);
    if (isNaN(moveTime) || moveTime < 10) {
      alert("Invalid movement time " + moveTime);
      return;
    }
    var pulseTimeMs = parseInt(el(c, "pulse_time_ms").value);
    if (isNaN(pulseTimeMs) || pulseTimeMs < 20) {
      alert("Invalid pulse time " + pulseTimeMs);
      return;
    }
    cfg = {
      name: name,
      move_time: moveTime,
      pulse_time_ms: pulseTimeMs,
      close_sensor_mode: parseInt(el(c, "close_sensor_mode").value),
    };
    if (c.data.open_sensor_mode >= 0) {
      cfg.open_sensor_mode = parseInt(el(c, "open_sensor_mode").value);
    }
    if (c.data.out_mode >= 0) {
      cfg.out_mode = parseInt(el(c, "out_mode").value);
    }
  }
  setComponentConfig(c, cfg, spinner);
}

el("reboot_btn").onclick = function() {
  axios.post(host + "/rpc/Sys.Reboot", {delay_ms: 500}).then(function(res) {
    alert("System is rebooting, please refresh the page.");
  });
}

function findOrAddContainer(cd) {
  var elId = "c" + cd.type + "-" + cd.id;
  var c = el(elId);
  if (c) return c;
  switch (cd.type) {
    case 0: // Switch
    case 1: // Outlet
    case 2: // Lock
      c = el("sw_template").cloneNode(true);
      c.id = elId;
      el(c, "toggle_btn").onclick = function() { swSetState(c, !c.data.state); };
      el(c, "save_btn").onclick = function() { swSetConfig(c); };
      el(c, "auto_off").onchange = function() { el(c, "auto_off_delay").disabled = !this.checked; };
      break;
    case 3: // Stateless Programmable Switch (aka input in detached mode).
      c = el("ssw_template").cloneNode(true);
      c.id = elId;
      el(c, "save_btn").onclick = function() { sswSetConfig(c); };
      break;
    case 4: // Window Covering
      c = el("wc_template").cloneNode(true);
      c.id = elId;
      el(c, "open_btn").onclick = function() {
        if (el(c, "open_spinner").className == "") {
          wcSetConfig(c, {tgt_pos: 100}, null);
          el(c, "open_spinner").className = "spin";
        } else {
          wcSetConfig(c, {tgt_pos: -1}, null);
        }
        el(c, "close_spinner").className = "";
      };
      el(c, "close_btn").onclick = function() {
        if (el(c, "close_spinner").className == "") {
          wcSetConfig(c, {tgt_pos: 0}, null);
          el(c, "close_spinner").className = "spin";
        } else {
          wcSetConfig(c, {tgt_pos: -1}, null);
        }
        el(c, "open_spinner").className = "";
      };
      el(c, "save_btn").onclick = function() {
        wcSetConfig(c, null, el(c, "save_spinner"));
      };
      el(c, "cal_btn").onclick = function() {
        wcSetConfig(c, {state: 10}, null);
        el(c, "cal_spinner").className = "spin";
      };
      break;
    case 5: // Garage Doot Opener
      c = el("gdo_template").cloneNode(true);
      c.id = elId;
      el(c, "save_btn").onclick = function() {
        gdoSetConfig(c, null, el(c, "save_spinner"));
      };
      el(c, "toggle_btn").onclick = function() {
        gdoSetConfig(c, {toggle: true}, el(c, "toggle_spinner"));
      };
      break;
  }
  if (c) {
    c.style.display = "block";
    el("components").appendChild(c);
  }
  return c;
}

function updateComponent(cd) {
  var c = findOrAddContainer(cd);
  if (!c) return;
  switch (cd.type) {
    case 0: // Switch
    case 1: // Outlet
    case 2: // Lock
      var headText = "Switch " + cd.id;
      if (cd.name) headText += " (" + cd.name + ")";
      el(c, "head").innerText = headText;
      el(c, "name").value = cd.name;
      el(c, "state").innerText = (cd.state ? "on" : "off");
      if (cd.apower !== undefined) {
        el(c, "power_stats").innerText = ", " + Math.round(cd.apower) + "W, " + cd.aenergy + "Wh";
      }
      el(c, "btn_label").innerText = "Turn " + (cd.state ? "Off" : "On");
      el(c, "svc_type_" + cd.svc_type).selected = true;
      el(c, "initial_" + cd.initial).selected = true;
      if (cd.in_mode >= 0) {
        el(c, "in_mode_" + cd.in_mode).selected = true;
        if (cd.in_mode != 3) {
          el(c, "in_inverted").checked = cd.in_inverted;
          el(c, "in_inverted_container").style.display = "block";
        }
      } else {
        el(c, "in_mode_container").style.display = "none";
        el(c, "in_inverted_container").style.display = "none";
        if (el(c, "initial_3")) el(c, "initial_3").remove();
      }
      el(c, "auto_off").checked = cd.auto_off;
      el(c, "auto_off_delay").disabled = !cd.auto_off;
      el(c, "auto_off_delay").value = secondsToDateString(cd.auto_off_delay);
      break;
    case 3: // Stateless Programmable Switch (aka input in detached mode).
      var headText = "Input " + cd.id;
      if (cd.name) headText += " (" + cd.name + ")";
      el(c, "head").innerText = headText;
      el(c, "name").value = cd.name;
      el(c, "in_mode_" + cd.in_mode).selected = true;
      var lastEvText = "n/a";
      if (cd.last_ev_age > 0) {
        var lastEv = cd.last_ev;
        switch (cd.last_ev) {
          case 0: lastEv = "single"; break;
          case 1: lastEv = "double"; break;
          case 2: lastEv = "long"; break;
          default: lastEv = cd.last_ev;
        }
        lastEvText = lastEv + " (" + secondsToDateString(cd.last_ev_age) + " ago)";
      }
      el(c, "last_event").innerText = lastEvText;
      break;
    case 4: // Window Covering
      el(c, "head").innerText = cd.name;
      el(c, "name").value = cd.name;
      el(c, "state").innerText = cd.state_str;
      el(c, "in_mode_" + cd.in_mode).selected = true;
      el(c, "swap_inputs").checked = cd.swap_inputs;
      el(c, "swap_outputs").checked = cd.swap_outputs;
      if (cd.cal_done == 1) {
        if (cd.cur_pos != cd.tgt_pos) {
          el(c, "pos").innerText = cd.cur_pos + " -> " + cd.tgt_pos;
        } else {
          el(c, "pos").innerText = cd.cur_pos;
        }
        el(c, "cal").innerText = "movement time: " + cd.move_time_ms / 1000 + " s, " +
                                 "avg power: " + cd.move_power + "W";
        el(c, "pos_ctl").style.display = "block";
      } else {
        el(c, "pos").innerText = "n/a";
        el(c, "cal").innerText = "not calibrated";
        el(c, "pos_ctl").style.display = "none";
      }
      if (cd.state >= 10 && cd.state < 20) {  // Calibration is ongoing.
        el(c, "cal_spinner").className = "spin";
        el(c, "cal").innerText = "in progress";
        autoRefresh = true;
      } else if (cd.state >= 20 && cd.state <= 25) {
        autoRefresh = true;
      } else {
        el(c, "cal_spinner").className = "";
        el(c, "open_spinner").className = "";
        el(c, "close_spinner").className = "";
      }
      break;
    case 5: // Garage Doot Opener
      el(c, "head").innerText = cd.name;
      el(c, "name").value = cd.name;
      el(c, "state").innerText = cd.cur_state_str;
      el(c, "close_sensor_mode_" + cd.close_sensor_mode).selected = true;
      el(c, "move_time").value = cd.move_time;
      el(c, "pulse_time_ms").value = cd.pulse_time_ms;
      if (cd.open_sensor_mode >= 0) {
        el(c, "open_sensor_mode_" + cd.open_sensor_mode).selected = true;
      } else {
        el(c, "open_sensor_mode_container").style.display = "none";
      }
      if (cd.out_mode >= 0) {
        el(c, "out_mode_" + cd.out_mode).selected = true;
      } else {
        el(c, "out_mode_container").style.display = "none";
      }
      break;
  }
  c.data = cd;
}

function getInfo() {
  axios.get(host + "/rpc/Shelly.GetInfo").then(function(res) {
    var data = res.data;
    lastInfo = data;
    console.log(data);
    el("uptime").innerText = durationStr(data.uptime);
    el("uptime_label").style.visibility = "visible";
    el("model").innerText = data.model;
    el("device_id").innerText = data.device_id;
    el("app_version").innerText = data.version + ' (build ' + data.fw_build + ')';
    if (data.failsafe_mode) {
      el("notify_failsafe").style.display = "inline";
      return;
    }

    el("device_name").innerText = el("sys_name").value = document.title = data.name;
    el("device_name").style.visibility = "visible";
    wifiEn.checked = data.wifi_en;
    wifiSSID.value = data.wifi_ssid;
    wifiPass.value = data.wifi_pass;
    var wifiStatus = "";
    if (data.wifi_rssi != 0) wifiStatus += "RSSI: " + data.wifi_rssi;
    if (data.wifi_ip != "") wifiStatus += ", IP: " + data.wifi_ip;
    if (!wifiStatus) {
      wifiStatus = "not connected";
    } else {
      // These only make sense if we are connected to WiFi.
      el("update_container").style.display = "block";
      el("revert_to_stock_container").style.display = "block";
      // We set external image URL to prevent loading it when not on WiFi, as it slows things down.
      el("donate_form_submit").src = "https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif";
      el("donate_form_submit").style.display = "inline";
    }
    el("wifi_status").innerText = (wifiStatus ? wifiStatus : "not connected");
    if (data.hap_running) {
      hapSetupCode.value = "***-**-***";
    } else {
      hapSetupCode.value = "";
    }
    el("hap_paired").innerText = (data.hap_paired ? "yes" : "no");
    if (data.hap_cn != el("components").cn) {
      el("components").innerHTML = "";
    }
    autoRefresh = false;
    for (var i in data.components) {
      updateComponent(data.components[i]);
    }
    el("components").cn = data.hap_cn;
    el("homekit_container").style.display = "block";
    if (data.wifi_ip !== undefined) {
      el("wifi_container").style.display = "block";
    }
    el("gs_container").style.display = "block";
    if (data.hap_running) {
      el("hap_conn_stats").innerText =
          data.hap_ip_conns_pending + " pending, " +
          data.hap_ip_conns_active + " active (" +
          data.hap_ip_conns_max + " max)";
    } else {
      el("hap_conn_stats").innerText = "server not running";
    }
    if (data.rsh_avail || data.gdo_avail) {
      if (!data.rsh_avail && el("sys_mode_1")) el("sys_mode_1").remove();
      if (!data.gdo_avail && el("sys_mode_2")) el("sys_mode_2").remove();
      (el("sys_mode_" + data.sys_mode) || {}).selected = true;
      el("sys_mode_container").style.display = "block";
    }
    if (data.debug_en) {
      el("debug_en").checked = true;
      el("debug_link").style.visibility = "visible";
    } else {
      el("debug_en").checked = false;
      el("debug_link").style.visibility = "hidden";
    }
    if (data.wifi_rssi != 0) {
      var last_update_check = parseInt(getCookie("last_update_check"));
      var now = new Date();
      console.log("Last update check:", last_update_check, new Date(last_update_check));
      if (isNaN(last_update_check) || now.getTime() - last_update_check > 24 * 60 * 60 * 1000) {
        checkUpdate();
      }
      el("notify_update").style.display = (getCookie("update_available") ? "block" : "none");
    }
    if (data.sys_temp !== undefined) {
      el("sys_temp").innerText = data.sys_temp;
      el("notify_overheat").style.display = (data.overheat_on ? "block" : "none");
      el("sys_temp_container").style.display = "block";
    } else {
      el("sys_temp_container").style.display = "none";
    }
    el("debug_log_container").style.display = "block";
  }).catch(function(err) {
    alert(err);
    console.log(err);
  }).then(function() {
    el("spinner").className = "";
  });
}

function getCookie(key) {
  var parts1 = document.cookie.split(";");
  for (var i in parts1) {
    var parts2 = parts1[i].split("=");
    if (parts2[0].trim() == key) return JSON.parse(parts2[1].trim());
  }
  return null;
}

function setCookie(key, value) {
  document.cookie = (key + "=" + JSON.stringify(value));
}

el("debug_en").onclick = function() {
  var debugEn = el("debug_en").checked;
  axios.post(host + "/rpc/Shelly.SetConfig", {config:{debug_en: debugEn}})
  .then(function(res) {
    getInfo();
  }).catch(function(err) {
    if (err.response) {
      err = err.response.data.message;
    }
    alert(err);
  });
};

el("refresh_btn").onclick = function() {
  el("spinner").className = "spin";
  getInfo();
}

function onLoad() {
  getInfo();
  setInterval(function() { if (autoRefresh) getInfo(); }, 1000);
}

function durationStr(d) {
  var days = parseInt(d / 86400); d %= 86400;
  var hours = parseInt(d / 3600); d %= 3600;
  var mins = parseInt(d / 60);
  var secs = d % 60;
  return days + ":" +
         nDigitString(hours, 2) + ":" +
         nDigitString(mins, 2) + ":" +
         nDigitString(secs, 2);
}

async function downloadUpdate(fwURL, spinner, status) {
  spinner.className = "spin";
  status.innerText = "Downloading...";
  console.log("Downloading", fwURL);
  fetch(fwURL, {mode: "cors"})
    .then(async (resp) => {
      console.log(resp);
      var blob = await resp.blob();
      if (!resp.ok || blob.type != "application/zip") {
        status.innerText = "Failed, try manually.";
        return;
      }
      return uploadFW(blob, spinner, status);
    }).catch((error) => {
      spinner.className = "";
      status.innerText = "Error downloading: " + error;
    });
}

async function uploadFW(blob, spinner, status) {
  spinner.className = "spin";
  status.innerText = "Uploading " + blob.size + " bytes...";
  var fd  = new FormData();
  fd.append("file", blob);
  fetch("/update", {
    method: "POST",
    mode: "cors",
    body: fd,
  })
  .then(async (resp) => {
    var respText = await resp.text();
    console.log("resp", resp, respText);
    spinner.className = "";
    status.innerText = respText;
    setCookie("update_available", false);
  }).catch((error) => {
    spinner.className = "";
    status.innerText = "Error uploading: " + error;
  });
}

// major.minor.patch-variantN
function parseVersion(vs) {
  var pp = vs.split("-");
  var v = pp[0].split(".");
  var variant = "", varSeq = 0;
  if (pp[1]) {
    var i = 0;
    for (i in pp[1]) {
      var c = pp[1][i];
      if (isNaN(parseInt(c))) {
        variant += c;
      } else {
        break;
      }
    }
    varSeq = parseInt(pp[1].substring(i)) || 0;
  }
  return {
    major: parseInt(v[0]),
    minor: parseInt(v[1]),
    patch: parseInt(v[2]),
    variant: variant,
    varSeq: varSeq,
  }
}

function isNewer(v1, v2) {
  var vi1 = parseVersion(v1), vi2 = parseVersion(v2);
  if (vi1.major != vi2.major) return (vi1.major > vi2.major);
  if (vi1.minor != vi2.minor) return (vi1.minor > vi2.minor);
  if (vi1.patch != vi2.patch) return (vi1.patch > vi2.patch);
  if (vi1.variant != vi2.variant) return true;
  if (vi1.varSeq != vi2.varSeq) return (vi1.varSeq > vi2.varSeq);
  return false;
}

async function checkUpdate() {
  var model = lastInfo.model;
  var curVersion = lastInfo.version;
  var e = el("update_status");
  var se = el("update_btn_spinner");
  var errMsg = 'Failed, check <a href="https://github.com/mongoose-os-apps/shelly-homekit/releases">GitHub</a>.';
  e.innerText = "";
  se.className = "spin";
  console.log("Model:", model, "Version:", curVersion);
  fetch("https://rojer.me/files/shelly/update.json",
        {headers: {
          "X-Model": model,
          "X-Current-Version": curVersion,
          "X-Current-Build": lastInfo.fw_build,
          "X-Device-ID": lastInfo.device_id,
        }})
    .then(resp => resp.json())
    .then((resp) => {
      var cfg, latestVersion, updateURL, relNotesURL;
      for (var i in resp) {
        var re = new RegExp(resp[i][0]);
        if (curVersion.match(re)) {
          cfg = resp[i][1];
          break;
        }
      }
      if (cfg) {
        latestVersion = cfg.version;
        relNotesURL = cfg.rel_notes;
        if (cfg.urls) updateURL = cfg.urls[model];
      }
      console.log("Version:", latestVersion, "URL:", updateURL);
      if (!latestVersion || !updateURL) {
        console.log("Update section not found:", model, curVersion, cfg);
        e.innerHTML = errMsg;
        se.className = "";
        return;
      }
      var updateAvailable = isNewer(latestVersion, curVersion);
      el("notify_update").style.display = (updateAvailable ? "block" : "none");
      setCookie("last_update_check", (new Date()).getTime());
      setCookie("update_available", updateAvailable);
      if (!updateAvailable) {
        e.innerText = "Up to date";
        se.className = "";
        return;
      }
      se.className = "";
      e.innerHTML = "Version " + latestVersion + " is available. " +
                    'See <a href="' + relNotesURL + '" target="_blank">release notes</a>.';
      el("update_btn_text").innerText = "Install";
      el("update_btn").onclick = function() {
        return downloadUpdate(updateURL, el("update_btn_spinner"), el("update_status"));
      };
    })
    .catch((error) => {
      console.log("Error", error);
      e.innerHTML = errMsg;
      se.className = "";
    });
}

el("update_btn").onclick = function() { checkUpdate(); };
el("revert_btn").onclick = function() {
  el("revert_msg").style.display = "block";
  var stockURL = "https://rojer.me/files/shelly/stock/" + lastInfo.stock_model + ".zip";
  downloadUpdate(stockURL, el("revert_btn_spinner"), el("revert_status"));
};

</script>

</body>
</html>
